<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI CoreWork - æ™ºèƒ½è¨­è¨ˆå”ä½œå¹³å°</title>
    
    <!-- KaTeX for mathematical formula rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
    
    <!-- html2canvas for canvas to image conversion -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <style>
        .right-panel-container {
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            gap: 10px;
            height: 100%;
        }
        
        .mindmap-area {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
            min-height: 200px;
        }
        
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            font-size: 14px;
        }
        
        .panel-divider {
            height: 4px;
            background: #ddd;
            cursor: row-resize;
            border-radius: 2px;
            transition: background 0.2s;
            position: relative;
            user-select: none;
        }
        
        .panel-divider:hover {
            background: #3498db;
        }
        
        .panel-divider::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 0;
            right: 0;
            height: 8px;
            cursor: row-resize;
        }
        
        .resizable-panel {
            min-height: 100px;
            overflow: hidden;
        }     * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #3498db;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .workspace {
            display: grid;
            grid-template-columns: 125px 1fr 300px;
            gap: 15px;
            margin-bottom: 20px;
            height: calc(100vh - 120px);
        }
        
        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .panel-header {
            background: #3498db;
            color: white;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .panel-content {
            padding: 12px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .drawing-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            position: relative;
            height: 500px;
        }
        
        #drawing-canvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            cursor: crosshair;
            display: block;
        }
        
        .tool-group {
            margin-bottom: 15px;
        }
        
        .tool-group h4 {
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 12px;
            text-align: center;
        }
        
        .tool-buttons, .mode-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .mode-buttons {
            grid-template-columns: 1fr 1fr;
        }
        
        .tool-btn, .mode-btn {
            background: #ecf0f1;
            border: 2px solid transparent;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            text-align: center;
        }
        
        .tool-btn:hover, .mode-btn:hover {
            background: #d5dbdb;
        }
        
        .tool-btn.active, .mode-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .mode-btn.active[data-mode="select"] {
            background: #e67e22;
            border-color: #d35400;
        }
        
        .color-picker {
            width: 100%;
            height: 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .color-swatches {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        
        .color-swatch {
            width: 100%;
            height: 25px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #2c3e50;
        }
        
        .size-slider {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .size-display {
            text-align: center;
            font-weight: 600;
            color: #3498db;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }

        /* å°è©±æ¡†æ¨£å¼ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dialog-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dialog-header {
            padding: 20px 20px 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .dialog-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 18px;
        }

        .dialog-body {
            padding: 20px;
        }

        .dialog-body p {
            margin: 0 0 20px 0;
            color: #666;
            text-align: center;
        }

        .mode-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mode-btn {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .mode-btn:hover {
            border-color: #3498db;
            background: #f8f9ff;
        }

        .mode-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }

        .mode-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .mode-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }

        .dialog-footer {
            padding: 15px 20px 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }
        
        .user-message {
            background: #e3f2fd;
            margin-left: 20px;
        }
        
        .ai-message {
            background: #f1f8e9;
            margin-right: 20px;
        }
        
        .chat-input {
            width: 100%;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            resize: vertical;
            font-family: inherit;
        }
        
        .send-button {
            width: 100%;
            margin-top: 10px;
        }
        
        .loading-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #3498db;
            font-weight: 600;
            z-index: 1000;
        }
        
        .main-content {
            display: none;
        }
        
        @media (max-width: 1000px) {
            .workspace {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        /* ç¯„ä¾‹å±•ç¤ºå€åŸŸ */
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .example-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .example-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .example-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        
        .example-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .example-description {
            font-size: 0.9rem;
            color: #7f8c8d;
            line-height: 1.4;
        }
        
        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #3498db;
            font-size: 16px;
        }
        
        .analysis-result {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .analysis-title {
            font-weight: 600;
            color: #27ae60;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
    <div id="loading" class="loading-text">ğŸ¨ è¼‰å…¥ä¸­...</div>
    
    <!-- ä¸»è¦å…§å®¹ -->
    <div id="main-content" class="main-content">
        <div class="container">
            <!-- æ¨™é¡Œ -->
            <div class="header">
                <h1>ğŸ¨ UI CoreWork</h1>
                <p>æ™ºèƒ½è¨­è¨ˆå”ä½œå¹³å° - ç¹ªåœ– & èŠå¤©</p>
            </div>
            
            <!-- ä¸»å·¥ä½œå€ -->
            <div class="workspace">
                <!-- å·¥å…·é¢æ¿ -->
                <div class="panel">
                    <div class="panel-header">ğŸ› ï¸ ç¹ªåœ–å·¥å…·</div>
                    <div class="panel-content">
                        <div class="tool-group">
                            <h4>åŠŸèƒ½</h4>
                            <button class="tool-btn" id="select-area-btn" style="width: 100%; margin-bottom: 10px; background: #3498db; color: white;">
                                ğŸ”² åœˆé¸å€åŸŸ
                            </button>
                            <button class="tool-btn" id="move-btn" style="width: 100%; margin-bottom: 10px; background: #9b59b6; color: white;">
                                ğŸ–ï¸ ç§»å‹•é¸å–
                            </button>
                            <button class="tool-btn" id="scale-btn" style="width: 100%; margin-bottom: 10px; background: #f39c12; color: white;">
                                ğŸ” ç¸®æ”¾é¸å–
                            </button>
                            <button class="tool-btn" id="delete-btn" style="width: 100%; margin-bottom: 10px; background: #e74c3c; color: white;">
                                ğŸ—‘ï¸ åˆªé™¤é¸å–
                            </button>
                            <button class="tool-btn" id="test-content-btn" style="width: 100%; margin-bottom: 10px; background: #9b59b6; color: white;">
                                ğŸ§ª æ·»åŠ æ¸¬è©¦å…§å®¹
                            </button>
                        </div>
                        
                        <div class="tool-group">
                            <h4>ç¹ªåœ–å·¥å…·</h4>
                            <div class="tool-buttons">
                                <button class="tool-btn active" data-tool="pen">âœï¸ ç­†</button>
                                <button class="tool-btn" data-tool="eraser">ğŸ§½ æ“¦</button>
                            </div>
                        </div>
                        
                        <div class="tool-group">
                            <h4>é¡è‰²</h4>
                            <input type="color" id="color-picker" class="color-picker" value="#2c3e50">
                            <div class="color-swatches">
                                <div class="color-swatch" style="background: #2c3e50;" data-color="#2c3e50"></div>
                                <div class="color-swatch" style="background: #e74c3c;" data-color="#e74c3c"></div>
                                <div class="color-swatch" style="background: #3498db;" data-color="#3498db"></div>
                                <div class="color-swatch" style="background: #2ecc71;" data-color="#2ecc71"></div>
                                <div class="color-swatch" style="background: #f39c12;" data-color="#f39c12"></div>
                                <div class="color-swatch" style="background: #9b59b6;" data-color="#9b59b6"></div>
                            </div>
                        </div>
                        
                        <div class="tool-group">
                            <h4>ç­†åˆ·å¤§å°</h4>
                            <input type="range" id="size-slider" class="size-slider" min="1" max="50" value="5">
                            <div id="size-display" class="size-display">5px</div>
                        </div>
                        
                        <div class="action-buttons">
                            <button id="clear-btn" class="btn btn-danger">æ¸…é™¤</button>
                            <button id="analyze-btn" class="btn btn-primary">åˆ†æåœ–åƒ</button>
                        </div>
                    </div>
                </div>
                
                <!-- ç¹ªåœ–å€åŸŸ -->
                <div class="panel">
                    <div class="panel-header">ğŸ¨ ç•«å¸ƒ</div>
                    <div class="panel-content">
                        <div class="drawing-area">
                            <canvas id="drawing-canvas"></canvas>
                        </div>
                        <div class="action-buttons">
                            <button id="save-btn" class="btn btn-primary">å„²å­˜ä½œå“</button>
                            <button id="save-to-project-btn" class="btn btn-primary">ä¿å­˜åˆ°é …ç›®</button>
                        </div>
                    </div>
                </div>
                
                <!-- å³å´é¢æ¿å€åŸŸ -->
                <div class="panel">
                    <div class="right-panel-container">
                        <!-- å¿ƒæ™ºåœ–å€åŸŸ -->
                        <div id="mindmap-panel" class="mindmap-section resizable-panel">
                            <div class="panel-header">ğŸ§  å¿ƒæ™ºåœ–å€åŸŸ</div>
                            <div class="mindmap-area">
                                <div>å¿ƒæ™ºåœ–åŠŸèƒ½é–‹ç™¼ä¸­...</div>
                            </div>
                        </div>
                        
                        <!-- åˆ†éš”ç·š -->
                        <div id="panel-resizer" class="panel-divider" title="æ‹–æ‹½èª¿æ•´å¤§å°"></div>
                        
                        <!-- èŠå¤©å€åŸŸ -->
                        <div id="chat-panel" class="chat-section resizable-panel">
                            <div class="panel-header">ğŸ’¬ AI åŠ©æ‰‹</div>
                            <div class="panel-content">
                                <div id="chat-messages" class="chat-messages">
                                    <div class="message ai-message">
                                        <strong>AI:</strong> æ­¡è¿ä½¿ç”¨ UI CoreWorkï¼æˆ‘å¯ä»¥ï¼š<br>
                                        ğŸ¨ åˆ†ææ‚¨çš„ç¹ªåœ–<br>
                                        ğŸ” æœå°‹ç›¸é—œç¯„ä¾‹<br>
                                        ğŸ“š æä¾›è¨­è¨ˆå»ºè­°<br>
                                        è«‹é–‹å§‹ç¹ªåœ–æˆ–å‘æˆ‘æå•ï¼
                                    </div>
                                </div>
                                <textarea id="chat-input" class="chat-input" placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯... (Enter ç™¼é€)&#10;ä¾‹å¦‚: 'è«‹åˆ†æé€™å€‹åœ–å½¢' æˆ– 'æ‰¾ä¸€äº›æŒ‰éˆ•è¨­è¨ˆç¯„ä¾‹'" style="height: 60px; font-size: 12px;"></textarea>
                                <button id="send-btn" class="btn btn-primary send-button" style="padding: 8px 12px; font-size: 12px;">ç™¼é€è¨Šæ¯</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç¯„ä¾‹åœ–ç‰‡å±•ç¤ºå€åŸŸ -->
            <div id="examples-section" class="panel" style="display: none; margin-top: 20px;">
                <div class="panel-header">ğŸ–¼ï¸ è¨­è¨ˆç¯„ä¾‹èˆ‡å»ºè­°</div>
                <div class="panel-content">
                    <div id="examples-grid" class="examples-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­ç½®é¢æ¿èª¿æ•´åŠŸèƒ½
        function setupPanelResizer() {
            const resizer = document.getElementById('panel-resizer');
            const mindMapPanel = document.getElementById('mind-map-panel');
            const chatPanel = document.getElementById('chat-panel');
            
            if (!resizer || !mindMapPanel || !chatPanel) {
                console.warn('Panel resizer elements not found');
                return;
            }
            
            let isResizing = false;
            let startY = 0;
            let startMindMapHeight = 0;
            let startChatHeight = 0;
            
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                startY = e.clientY;
                startMindMapHeight = mindMapPanel.offsetHeight;
                startChatHeight = chatPanel.offsetHeight;
                
                document.body.style.cursor = 'row-resize';
                document.body.style.userSelect = 'none';
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const deltaY = e.clientY - startY;
                const containerHeight = mindMapPanel.parentElement.offsetHeight;
                const resizerHeight = resizer.offsetHeight;
                const availableHeight = containerHeight - resizerHeight;
                
                let newMindMapHeight = startMindMapHeight + deltaY;
                let newChatHeight = startChatHeight - deltaY;
                
                // è¨­ç½®æœ€å°é«˜åº¦é™åˆ¶
                const minHeight = 100;
                if (newMindMapHeight < minHeight) {
                    newMindMapHeight = minHeight;
                    newChatHeight = availableHeight - minHeight;
                } else if (newChatHeight < minHeight) {
                    newChatHeight = minHeight;
                    newMindMapHeight = availableHeight - minHeight;
                }
                
                // ç¢ºä¿ç¸½é«˜åº¦ä¸è¶…éå®¹å™¨é«˜åº¦
                if (newMindMapHeight + newChatHeight > availableHeight) {
                    const ratio = availableHeight / (newMindMapHeight + newChatHeight);
                    newMindMapHeight *= ratio;
                    newChatHeight *= ratio;
                }
                
                mindMapPanel.style.height = newMindMapHeight + 'px';
                chatPanel.style.height = newChatHeight + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }
        
        // ç­‰å¾… DOM è¼‰å…¥å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('UI CoreWork initializing...');
            console.log('Loading element:', document.getElementById('loading'));
            console.log('Main content element:', document.getElementById('main-content'));
            
            // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨ï¼Œé¡¯ç¤ºä¸»è¦å…§å®¹
            setTimeout(() => {
                const loadingEl = document.getElementById('loading');
                const mainContentEl = document.getElementById('main-content');
                
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                    console.log('Loading hidden');
                } else {
                    console.error('Loading element not found!');
                }
                
                if (mainContentEl) {
                    mainContentEl.style.display = 'block';
                    console.log('Main content shown');
                    initializeApp();
                } else {
                    console.error('Main content element not found!');
                }
            }, 500);
        });
        
        // ===== å…¨å±€å‡½æ•¸è²æ˜ =====
        
        // èŠå¤©æ¶ˆæ¯å‡½æ•¸
        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) {
                console.warn('Chat messages element not found');
                return;
            }
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (sender === 'AI' ? 'ai-message' : 'user-message');
            messageDiv.innerHTML = '<strong>' + sender + ':</strong> ' + message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ç¹ªè£½é¸æ“‡çŸ©å½¢
        function drawSelectionRect() {
            if (!ctx || !canvas) return; // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
            
            redrawCanvas();
            
            // ç¹ªè£½é¸æ“‡çŸ©å½¢
            ctx.save();
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(
                selectionStart.x,
                selectionStart.y,
                selectionEnd.x - selectionStart.x,
                selectionEnd.y - selectionStart.y
            );
            ctx.restore();
        }
        
        // é‡ç¹ªç•«å¸ƒ
        function redrawCanvas() {
            if (!ctx || !canvas) return; // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // é‡ç¹ªæ‰€æœ‰ç­†ç•«
            strokes.forEach(stroke => {
                // å¦‚æœæ˜¯åœ–ç‰‡é¡å‹çš„ç­†ç•«ï¼ˆå…¬å¼æ¸²æŸ“çµæœï¼‰
                if (stroke.tool === 'image' && stroke.image) {
                    ctx.save();
                    ctx.drawImage(stroke.image, stroke.x, stroke.y, stroke.width, stroke.height);
                    ctx.restore();
                    return;
                }
                
                // åŸæœ‰çš„ç­†ç•«ç¹ªè£½é‚è¼¯
                if (stroke.points && stroke.points.length < 2) return;
                
                ctx.save();
                ctx.globalCompositeOperation = stroke.tool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.lineWidth = stroke.size;
                ctx.strokeStyle = stroke.color;
                
                ctx.beginPath();
                ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
                
                for (let i = 1; i < stroke.points.length; i++) {
                    ctx.lineTo(stroke.points[i].x, stroke.points[i].y);
                }
                
                ctx.stroke();
                ctx.restore();
            });

            // é‡ç¹ªæ‰€æœ‰åœ–ç‰‡
            images.forEach(image => {
                ctx.save();
                if (image.imageData) {
                    // å¦‚æœæ˜¯çœŸå¯¦åœ–ç‰‡æ•¸æ“š
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, image.x, image.y, image.width, image.height);
                    };
                    img.src = image.imageData;
                } else if (image.color) {
                    // æ¸¬è©¦å…§å®¹ï¼šç¹ªè£½å½©è‰²çŸ©å½¢
                    ctx.fillStyle = image.color;
                    ctx.fillRect(image.x, image.y, image.width, image.height);
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(image.x, image.y, image.width, image.height);

                    // å¦‚æœæœ‰æ–‡æœ¬ï¼ˆå¦‚å…¬å¼ï¼‰ï¼Œç¹ªè£½æ–‡æœ¬
                    if (image.text) {
                        ctx.fillStyle = '#fff';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(image.text,
                                   image.x + image.width/2,
                                   image.y + image.height/2);
                    }
                }
                ctx.restore();
            });
        }
        
        // è™•ç†é¸ä¸­å€åŸŸ
        function processSelection(selection) {
            if (!ctx || !canvas) return; // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
            
            console.log('Selection area:', selection);
            
            // æå–é¸ä¸­å€åŸŸçš„åœ–åƒæ•¸æ“š
            const imageData = ctx.getImageData(selection.x, selection.y, selection.width, selection.height);
            
            // å‰µå»ºè‡¨æ™‚canvasä¾†è™•ç†é¸ä¸­å€åŸŸ
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = selection.width;
            tempCanvas.height = selection.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // å…ˆå¡«å……ç™½è‰²èƒŒæ™¯ï¼Œç¢ºä¿æ•¸å­¸å…¬å¼è­˜åˆ¥æ¸…æ™°åº¦
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // å†æ”¾ä¸Šé¸ä¸­çš„å…§å®¹
            tempCtx.putImageData(imageData, 0, 0);
            
            // è½‰æ›ç‚ºbase64åœ–åƒ
            const imageBase64 = tempCanvas.toDataURL('image/png');
            
            // é¡¯ç¤ºè™•ç†é¸é …
            showSelectionOptions(selection, imageBase64);
        }
        
        // é¡¯ç¤ºé¸æ“‡è™•ç†é¸é …ï¼ˆä½¿ç”¨çµ•å°å®šä½æµ®å‹•æŒ‰éˆ•ï¼‰
        function showSelectionOptions(selection, imageBase64) {
            console.log('ğŸ¨ showSelectionOptions è¢«èª¿ç”¨');
            console.log('   é¸æ“‡å€åŸŸ:', selection);
            console.log('   åœ–ç‰‡æ•¸æ“šå­˜åœ¨:', !!imageBase64);
            
            // ç§»é™¤ä»»ä½•ç¾æœ‰çš„é¸æ“‡æŒ‰éˆ•
            removeSelectionButtons();
            
            // å‰µå»ºæµ®å‹•æŒ‰éˆ•å®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.id = 'selection-buttons';
            buttonContainer.style.cssText = `
                position: absolute;
                background: white;
                border: 2px solid #007bff;
                border-radius: 8px;
                padding: 12px;
                box-shadow: 0 6px 20px rgba(0,0,0,0.15);
                z-index: 1000;
                display: flex;
                flex-direction: column;
                gap: 10px;
                min-width: 220px;
                font-family: Arial, sans-serif;
            `;
            
            // è¨ˆç®—æŒ‰éˆ•ä½ç½®ï¼ˆç›¸å°æ–¼ç•«å¸ƒå®¹å™¨ï¼‰
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = canvas.parentElement.getBoundingClientRect();
            
            // åˆå§‹ä½ç½®ï¼šé¸æ“‡æ¡†å³å´
            let buttonX = selection.x + selection.width + 15;
            let buttonY = selection.y;
            
            // æ™ºèƒ½ä½ç½®èª¿æ•´
            const buttonWidth = 220;
            const buttonHeight = 180;
            
            // å¦‚æœå³å´ç©ºé–“ä¸å¤ ï¼Œæ”¾åœ¨å·¦å´
            if (buttonX + buttonWidth > canvas.width) {
                buttonX = selection.x - buttonWidth - 15;
            }
            
            // å¦‚æœå·¦å´ä¹Ÿä¸å¤ ï¼Œæ”¾åœ¨é¸æ“‡æ¡†ä¸‹æ–¹
            if (buttonX < 0) {
                buttonX = selection.x;
                buttonY = selection.y + selection.height + 15;
            }
            
            // å¦‚æœä¸‹æ–¹ç©ºé–“ä¸å¤ ï¼Œæ”¾åœ¨ä¸Šæ–¹
            if (buttonY + buttonHeight > canvas.height) {
                buttonY = selection.y - buttonHeight - 15;
            }
            
            // ç¢ºä¿ä¸è¶…å‡ºé‚Šç•Œ
            buttonX = Math.max(10, Math.min(buttonX, canvas.width - buttonWidth - 10));
            buttonY = Math.max(10, Math.min(buttonY, canvas.height - buttonHeight - 10));
            
            // è½‰æ›ç‚ºé é¢çµ•å°åæ¨™
            buttonContainer.style.left = (containerRect.left + buttonX) + 'px';
            buttonContainer.style.top = (containerRect.top + buttonY) + 'px';
            
            // å‰µå»ºæ¨™é¡Œ
            const title = document.createElement('div');
            title.style.cssText = `
                font-weight: bold; 
                margin-bottom: 8px; 
                color: #333;
                font-size: 14px;
                text-align: center;
            `;
            title.textContent = `é¸ä¸­å€åŸŸ ${Math.round(selection.width)}Ã—${Math.round(selection.height)}`;
            buttonContainer.appendChild(title);
            
            // å‰µå»ºæ•¸å­¸å…¬å¼è½‰æ›æŒ‰éˆ•
            const mathButton = document.createElement('button');
            mathButton.style.cssText = `
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            `;
            mathButton.innerHTML = 'ğŸ§® æ•¸å­¸å…¬å¼è½‰æ›';
            mathButton.onmouseover = () => mathButton.style.transform = 'translateY(-1px)';
            mathButton.onmouseout = () => mathButton.style.transform = 'translateY(0)';
            mathButton.onclick = () => {
                removeSelectionButtons();
                processMathFormula({selection, imageBase64});
            };
            buttonContainer.appendChild(mathButton);
            
            // å‰µå»ºå¿ƒæ™ºåœ–ç·¨è¼¯æŒ‰éˆ•
            const mindmapButton = document.createElement('button');
            mindmapButton.style.cssText = `
                background: linear-gradient(135deg, #17a2b8, #138496);
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            `;
            mindmapButton.innerHTML = 'ğŸ—ºï¸ å¿ƒæ™ºåœ–ç·¨è¼¯';
            mindmapButton.onmouseover = () => mindmapButton.style.transform = 'translateY(-1px)';
            mindmapButton.onmouseout = () => mindmapButton.style.transform = 'translateY(0)';
            mindmapButton.onclick = () => {
                removeSelectionButtons();
                processMindMap({selection, imageBase64});
            };
            buttonContainer.appendChild(mindmapButton);
            
            // å‰µå»ºå–æ¶ˆæŒ‰éˆ•
            const cancelButton = document.createElement('button');
            cancelButton.style.cssText = `
                background: linear-gradient(135deg, #dc3545, #c82333);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                font-weight: 500;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            `;
            cancelButton.innerHTML = 'âŒ å–æ¶ˆé¸æ“‡';
            cancelButton.onmouseover = () => cancelButton.style.transform = 'translateY(-1px)';
            cancelButton.onmouseout = () => cancelButton.style.transform = 'translateY(0)';
            cancelButton.onclick = () => {
                removeSelectionButtons();
                clearSelection();
            };
            buttonContainer.appendChild(cancelButton);
            
            // æ·»åŠ åˆ°é é¢
            document.body.appendChild(buttonContainer);
            console.log('âœ… é¸é …èœå–®å·²æ·»åŠ åˆ°é é¢');
            console.log('   ä½ç½®:', buttonX, buttonY);
            console.log('   å®¹å™¨ID:', buttonContainer.id);
            
            // æš«å­˜é¸æ“‡æ•¸æ“šä¾›å¾ŒçºŒä½¿ç”¨
            window.currentSelectionData = {
                selection: selection,
                imageBase64: imageBase64
            };
            console.log('âœ… é¸æ“‡æ•¸æ“šå·²æš«å­˜åˆ° window.currentSelectionData');
        }
        
        // ç§»é™¤é¸æ“‡æŒ‰éˆ•
        function removeSelectionButtons() {
            const existingButtons = document.getElementById('selection-buttons');
            if (existingButtons) {
                existingButtons.remove();
                console.log('Selection buttons removed');
            }
            // âš ï¸ é‡è¦ï¼šæ¸…é™¤æš«å­˜çš„é¸æ“‡æ•¸æ“šï¼Œé˜²æ­¢èª¤æ“ä½œ
            window.currentSelectionData = null;
            console.log('âœ… é¸æ“‡æ•¸æ“šå·²æ¸…é™¤');
        }
        
        // æ¸…é™¤é¸æ“‡å€åŸŸ
        function clearSelection() {
            isSelecting = false;
            isReadyToSelect = false;  // é‡ç½®æº–å‚™æ¨™å¿—
            selectionStart = {x: 0, y: 0};
            selectionEnd = {x: 0, y: 0};
            currentSelection = null;
            window.currentSelectionData = null;
            redrawCanvas();
            console.log('Selection cleared');
        }
        
        // ===== åœˆé¸åŠŸèƒ½å¯¦ç¾ =====
        function startSelection(e) {
            if (!canvas || !ctx) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // ç¢ºä¿ç¹ªåœ–æ¨¡å¼é—œé–‰ï¼Œé–‹å§‹é¸æ“‡
            isDrawing = false;
            isSelecting = true;
            selectionStart = {x: x, y: y};

            // æ›´æ–°æ¸¸æ¨™ç‚ºåœˆé¸ç‹€æ…‹
            updateCanvasCursor();
            selectionEnd = {x: x, y: y};
            
            console.log('ğŸ”² é–‹å§‹åœˆé¸:', selectionStart);
        }
        
        function updateSelection(e) {
            if (!isSelecting) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            selectionEnd = {x: x, y: y};
            redrawCanvas();
            
            // ç¹ªè£½é¸æ“‡çŸ©å½¢
            const selection = {
                x: Math.min(selectionStart.x, selectionEnd.x),
                y: Math.min(selectionStart.y, selectionEnd.y),
                width: Math.abs(selectionEnd.x - selectionStart.x),
                height: Math.abs(selectionEnd.y - selectionStart.y)
            };
            
            ctx.save();
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(selection.x, selection.y, selection.width, selection.height);
            ctx.restore();
        }
        
        function endSelection(e) {
            console.log('ğŸ” endSelection è¢«èª¿ç”¨, isSelecting:', isSelecting);
            
            if (!isSelecting) {
                console.log('âš ï¸  ä¸åœ¨åœˆé¸æ¨¡å¼ï¼Œé€€å‡º');
                return;
            }
            
            // âš ï¸ é‡è¦ï¼šæ›´æ–°æœ€çµ‚ä½ç½®ï¼ˆé˜²æ­¢ mousemove æœªè§¸ç™¼ï¼‰
            const rect = canvas.getBoundingClientRect();
            const finalX = e.clientX - rect.left;
            const finalY = e.clientY - rect.top;
            selectionEnd = {x: finalX, y: finalY};
            
            console.log('ğŸ”² åœˆé¸èµ·é»:', selectionStart);
            console.log('ğŸ”² åœˆé¸çµ‚é»:', selectionEnd);
            
            const selection = {
                x: Math.min(selectionStart.x, selectionEnd.x),
                y: Math.min(selectionStart.y, selectionEnd.y),
                width: Math.abs(selectionEnd.x - selectionStart.x),
                height: Math.abs(selectionEnd.y - selectionStart.y)
            };
            
            console.log('ğŸ”² å®Œæˆåœˆé¸:', selection);
            console.log('   å€åŸŸå°ºå¯¸:', selection.width, 'x', selection.height);
            
            if (selection.width > 10 && selection.height > 10) {
                if (isMoving) {
                    // ç§»å‹•æ¨¡å¼ï¼šé¡¯ç¤ºé¸å–æ¨¡å¼é¸æ“‡å°è©±æ¡†
                    console.log('ğŸ–ï¸ ç§»å‹•æ¨¡å¼åœˆé¸å®Œæˆï¼Œé¡¯ç¤ºæ¨¡å¼é¸æ“‡');
                    showSelectionModeDialog(selection);
                } else {
                    // åŸæœ‰åœˆé¸åŠŸèƒ½
                    console.log('âœ… å€åŸŸæœ‰æ•ˆï¼Œèª¿ç”¨ processSelection');
                    processSelection(selection);
                }
                
                // âš ï¸ åœˆé¸å®Œæˆå¾Œï¼Œé€€å‡ºåœˆé¸æ¨¡å¼ä¸¦æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                isReadyToSelect = false;
                const selectAreaBtn = document.getElementById('select-area-btn');
                if (selectAreaBtn) {
                    selectAreaBtn.style.background = '#3498db';  // æ¢å¾©åŸè‰²
                }
                console.log('âœ… åœˆé¸å®Œæˆï¼Œå·²è‡ªå‹•é€€å‡ºåœˆé¸æ¨¡å¼');
            } else {
                console.log('âŒ é¸æ“‡å€åŸŸå¤ªå°ï¼Œå·²å¿½ç•¥');
                console.log('   ğŸ› èª¿è©¦ä¿¡æ¯:');
                console.log('      èµ·é» (selectionStart):', selectionStart);
                console.log('      çµ‚é» (selectionEnd):', selectionEnd);
                console.log('      è¨ˆç®—å¯¬åº¦:', Math.abs(selectionEnd.x - selectionStart.x));
                console.log('      è¨ˆç®—é«˜åº¦:', Math.abs(selectionEnd.y - selectionStart.y));
                addChatMessage('AI', `âš ï¸  **é¸æ“‡å€åŸŸå¤ªå°** (${selection.width}Ã—${selection.height} åƒç´ )\n\nè«‹åœˆé¸æ›´å¤§çš„å€åŸŸï¼ˆè‡³å°‘ 10Ã—10 åƒç´ ï¼‰ã€‚\n\nğŸ’¡ æç¤ºï¼šæŒ‰ä½é¼ æ¨™å·¦éµä¸¦**ç·©æ…¢æ‹–å‹•**åˆ°ç›®æ¨™ä½ç½®å¾Œå†æ¾é–‹ã€‚`);
            }
            
            isSelecting = false;
            redrawCanvas();
        }
        
        // è™•ç†åœˆé¸çµæœ - é¡¯ç¤ºæµ®å‹•é¸é …èœå–®
        function processSelection(selection) {
            console.log('ğŸ¯ processSelection è¢«èª¿ç”¨');
            console.log('   é¸æ“‡å€åŸŸ:', selection);
            
            // æå–é¸ä¸­å€åŸŸçš„åœ–ç‰‡æ•¸æ“š
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = selection.width;
            tempCanvas.height = selection.height;
            
            // å‰µå»ºç™½è‰²èƒŒæ™¯
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, selection.width, selection.height);
            
            // è¤‡è£½é¸ä¸­å€åŸŸ
            tempCtx.drawImage(canvas, 
                selection.x, selection.y, selection.width, selection.height,
                0, 0, selection.width, selection.height
            );
            
            const imageBase64 = tempCanvas.toDataURL('image/png');
            console.log('   åœ–ç‰‡æ•¸æ“šå·²æå–, å¤§å°:', imageBase64.length, 'å­—ç¯€');
            
            // é¡¯ç¤ºæµ®å‹•é¸é …èœå–®
            console.log('   èª¿ç”¨ showSelectionOptions...');
            showSelectionOptions(selection, imageBase64);
        }
        
        function updateCanvasCursor() {
            const canvas = document.getElementById('drawing-canvas');
            if (!canvas) return;

            if (isReadyToSelect || isSelecting) {
                canvas.style.cursor = 'crosshair';
                canvas.title = 'æ‹–æ‹½é¸æ“‡å€åŸŸ';
            } else if (isMoving) {
                if (selectedItems.length > 0) {
                    canvas.style.cursor = 'move';
                    canvas.title = 'æ‹–æ‹½ç§»å‹•é¸ä¸­å…§å®¹';
                } else {
                    canvas.style.cursor = 'crosshair';
                    canvas.title = 'åœˆé¸è¦ç§»å‹•çš„å…§å®¹';
                }
            } else {
                canvas.style.cursor = 'crosshair';
                canvas.title = 'é»æ“Šæ‹–æ‹½ç¹ªç•«ï¼ŒæŒ‰ä½Shiftæ‹–æ‹½åœˆé¸å€åŸŸ';
            }
        }
        
        // ===== çµ±ä¸€ç•«å¸ƒäº‹ä»¶è™•ç† =====
        function handleCanvasMouseDown(e) {
            console.log('ğŸ–±ï¸  mousedown, isSelecting:', isSelecting, ', isReadyToSelect:', isReadyToSelect, ', isMoving:', isMoving, ', selectedItems:', selectedItems.length);

            // å¦‚æœæº–å‚™åœˆé¸ï¼Œå‰‡å•Ÿå‹•åœˆé¸
            if (isReadyToSelect) {
                console.log('ğŸ”² å•Ÿå‹•åœˆé¸');
                isReadyToSelect = false;  // æ¸…é™¤æº–å‚™æ¨™å¿—
                startSelection(e);
            } else if (isSelecting) {
                // å·²ç¶“åœ¨åœˆé¸ä¸­ï¼ˆç†è«–ä¸Šä¸æœƒåˆ°é€™è£¡ï¼‰
                console.log('ğŸ”² ç¹¼çºŒåœˆé¸');
                startSelection(e);
            } else if (isMoving) {
                // ç§»å‹•æ¨¡å¼
                if (selectedItems.length > 0) {
                    // æœ‰é¸ä¸­é …ç›®ï¼šé–‹å§‹æ‹–æ‹½
                    console.log('ğŸ–ï¸ é–‹å§‹ç§»å‹•æ‹–æ‹½å·²é¸ä¸­çš„å…§å®¹');
                    isDragging = true;
                    const rect = canvas.getBoundingClientRect();
                    moveStartPoint = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                } else {
                    // æ²’æœ‰é¸ä¸­é …ç›®ï¼šé–‹å§‹åœˆé¸
                    console.log('ğŸ”² ç§»å‹•æ¨¡å¼ï¼šå•Ÿå‹•åœˆé¸ä¾†é¸æ“‡è¦ç§»å‹•çš„å…§å®¹');
                    startSelection(e);
                }
            } else {
                console.log('âœï¸  å•Ÿå‹•ç¹ªåœ–');
                startDrawing(e);
            }
        }
        
        function handleCanvasMouseMove(e) {
            if (isDrawing) {
                draw(e);
            } else if (isSelecting) {
                // æ·»åŠ æ—¥å¿—ç¢ºèª mousemove è¢«è§¸ç™¼
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                console.log('ğŸ”„ mousemove (åœˆé¸ä¸­):', Math.round(x), ',', Math.round(y));
                updateSelection(e);
            } else if (isDragging) {
                // ç§»å‹•æ¨¡å¼ï¼šæ‹–æ‹½é¸ä¸­å…§å®¹
                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                const deltaX = currentX - moveStartPoint.x;
                const deltaY = currentY - moveStartPoint.y;
                
                console.log('ğŸ”„ ç§»å‹•æ‹–æ‹½: Î”x=' + deltaX.toFixed(1) + ', Î”y=' + deltaY.toFixed(1));
                
                // ç§»å‹•æ‰€æœ‰é¸ä¸­é …ç›®
                moveSelectedItems(deltaX, deltaY);
                
                // æ›´æ–°èµ·å§‹é»ç‚ºç•¶å‰ä½ç½®
                moveStartPoint.x = currentX;
                moveStartPoint.y = currentY;
            }
        }
        
        function handleCanvasMouseUp(e) {
            console.log('ğŸ–±ï¸  mouseup, isDrawing:', isDrawing, ', isSelecting:', isSelecting, ', isReadyToSelect:', isReadyToSelect);
            
            if (isDrawing) {
                console.log('âœï¸  åœæ­¢ç¹ªåœ–');
                stopDrawing(e);
            } else if (isSelecting) {
                console.log('ğŸ”² çµæŸåœˆé¸');
                endSelection(e);
            } else if (isDragging) {
                // ç§»å‹•æ¨¡å¼ï¼šçµæŸæ‹–æ‹½
                console.log('ğŸ–ï¸ çµæŸç§»å‹•æ‹–æ‹½');
                isDragging = false;
                addChatMessage('AI', 'âœ… **ç§»å‹•å®Œæˆ**');
                updateCanvasCursor(); // æ›´æ–°æ¸¸æ¨™ç‹€æ…‹
            } else if (isReadyToSelect) {
                // å¦‚æœæº–å‚™åœˆé¸ä½†æ²’æœ‰çœŸæ­£é–‹å§‹ï¼ˆä¾‹å¦‚åªæ˜¯ç§»å‹•é¼ æ¨™ï¼‰ï¼Œå–æ¶ˆæº–å‚™ç‹€æ…‹
                console.log('âš ï¸  å–æ¶ˆåœˆé¸æº–å‚™ï¼ˆæœªé–‹å§‹åœˆé¸å°± mouseupï¼‰');
                isReadyToSelect = false;
            } else {
                console.log('âš ï¸  æ—¢ä¸åœ¨ç¹ªåœ–ä¹Ÿä¸åœ¨åœˆé¸ç‹€æ…‹');
            }
        }
        
        function handleCanvasMouseOut(e) {
            if (isDrawing) {
                stopDrawing(e);
            }
        }
        

        
        // è™•ç†æ•¸å­¸å…¬å¼è½‰æ›
        async function processMathFormula(selectionData) {
            // âš ï¸ å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ selectionData å­˜åœ¨ä¸”æœ‰æ•ˆ
            if (!selectionData || !selectionData.imageBase64) {
                console.error('âŒ processMathFormula: selectionData ç„¡æ•ˆæˆ–ç‚ºç©º');
                addChatMessage('AI', 'âŒ **è™•ç†å¤±æ•—**\n\né¸æ“‡æ•¸æ“šç„¡æ•ˆï¼Œè«‹é‡æ–°åœˆé¸ã€‚');
                return;
            }
            
            addChatMessage('AI', 'ğŸ§® æ­£åœ¨åˆ†ææ•¸å­¸å…¬å¼...');
            
            try {
                // èª¿ç”¨å°ˆé–€çš„æ•¸å­¸å…¬å¼åˆ†æAPI
                const response = await fetch('/api/analyze-math', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_data: selectionData.imageBase64
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.latex) {
                    console.log('âœ… AIè¿”å›LaTeX:', result.latex);
                    
                    // å…ˆæ¸…ç†LaTeXæ ¼å¼ä»¥ä¾›é¡¯ç¤º
                    let displayLatex = result.latex.trim();
                    displayLatex = displayLatex.replace(/\\\[/g, '').replace(/\\\]/g, '');
                    displayLatex = displayLatex.replace(/\\\(/g, '').replace(/\\\)/g, '');
                    displayLatex = displayLatex.replace(/^\$\$/, '').replace(/\$\$$/, '');
                    displayLatex = displayLatex.replace(/^\$/, '').replace(/\$$/, '');
                    displayLatex = displayLatex.trim();
                    
                    // âš ï¸ æª¢æŸ¥æ¸…ç†å¾Œçš„LaTeXæ˜¯å¦ç‚ºç©ºï¼ˆé¿å…èª¤åˆªç•«å¸ƒå…§å®¹ï¼‰
                    if (!displayLatex || displayLatex.length === 0) {
                        console.error('âŒ AIè¿”å›ç©ºLaTeXï¼Œæ‹’çµ•è™•ç†');
                        addChatMessage('AI', 'âŒ **è­˜åˆ¥å¤±æ•—**\n\nç„¡æ³•è­˜åˆ¥åœˆé¸å€åŸŸçš„æ•¸å­¸å…¬å¼ã€‚\nå¯èƒ½åŸå› ï¼š\nâ€¢ åœˆé¸äº†å·²ç¶“è½‰æ›éçš„å…¬å¼ï¼ˆè«‹åœˆé¸æ‰‹å¯«å…§å®¹ï¼‰\nâ€¢ AIè­˜åˆ¥å¤±æ•—\nâ€¢ åœ–ç‰‡ä¸æ¸…æ™°');
                        isSelecting = false;
                        isReadyToSelect = false;
                        return;
                    }
                    
                    addChatMessage('AI', `ğŸ§® **è­˜åˆ¥æˆåŠŸï¼**\n\nğŸ“ LaTeX: \`${displayLatex}\`\nğŸ¯ ä¿¡å¿ƒåº¦: ${Math.round((result.confidence || 0) * 100)}%`);
                    
                    console.log('ğŸ¨ é–‹å§‹æ¸²æŸ“å…¬å¼...');
                    // ä½¿ç”¨KaTeXæ¸²æŸ“å…¬å¼
                    renderMathFormula(result.latex, selectionData.selection);
                } else if (result.success && result.analysis) {
                    // å¦‚æœæ²’æœ‰LaTeXä½†æœ‰åˆ†æçµæœï¼Œå˜—è©¦æå–
                    const latex = extractLatexFromResponse(result.analysis);
                    
                    if (latex) {
                        addChatMessage('AI', `ğŸ§® **åˆ†æçµæœï¼š**\n${result.analysis}\n\nğŸ“ æå–çš„LaTeX: \`${latex}\``);
                        renderMathFormula(latex, selectionData.selection);
                    } else {
                        addChatMessage('AI', `ğŸ“ **åˆ†æçµæœï¼š**\n${result.analysis}\n\nâš ï¸ æœªèƒ½è­˜åˆ¥å‡ºæ¨™æº–æ•¸å­¸å…¬å¼æ ¼å¼ã€‚`);
                    }
                } else {
                    addChatMessage('AI', `âŒ å…¬å¼åˆ†æå¤±æ•—ï¼š${result.error || 'è«‹ç¢ºä¿é¸ä¸­å€åŸŸåŒ…å«æ¸…æ™°çš„æ•¸å­¸å…¬å¼ã€‚'}`);
                }
            } catch (error) {
                console.error('Math formula processing error:', error);
                addChatMessage('AI', 'âŒ é€£æ¥åˆ†ææœå‹™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
            
            // æ¸…é™¤é¸æ“‡æ•¸æ“š
            window.currentSelectionData = null;
        }
        
        // å¾AIå›æ‡‰ä¸­æå–LaTeXå…¬å¼
        function extractLatexFromResponse(response) {
            // å°‹æ‰¾LaTeXæ ¼å¼çš„å…¬å¼ï¼ˆ$...$ æˆ– $$...$$ï¼‰
            const latexPatterns = [
                /\$\$([^$]+)\$\$/g,  // $$...$$
                /\$([^$]+)\$/g,      // $...$
                /\\begin\{[^}]+\}.*?\\end\{[^}]+\}/gs,  // \begin{...}...\end{...}
            ];
            
            for (const pattern of latexPatterns) {
                const matches = response.match(pattern);
                if (matches && matches.length > 0) {
                    return matches[0];
                }
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°æ¨™æº–LaTeXæ ¼å¼ï¼Œå˜—è©¦æå–å¯èƒ½çš„æ•¸å­¸è¡¨é”å¼
            const mathKeywords = ['equation', 'formula', 'expression', 'å…¬å¼', 'æ–¹ç¨‹'];
            if (mathKeywords.some(keyword => response.toLowerCase().includes(keyword))) {
                // è¿”å›ç°¡åŒ–çš„LaTeXæ ¼å¼
                return response.replace(/[^\w\s\+\-\*\/\=\(\)\^\{\}]/g, '');
            }
            
            return null;
        }
        
        // æ¸²æŸ“æ•¸å­¸å…¬å¼ä¸¦æ›¿æ›åˆ°ç•«å¸ƒ - å®Œå…¨é‡å¯«ç‰ˆæœ¬
        function renderMathFormula(latex, selection) {
            console.log('ğŸ¯ renderMathFormula é–‹å§‹åŸ·è¡Œ');
            console.log('   è¼¸å…¥LaTeX:', latex);
            console.log('   é¸æ“‡å€åŸŸ:', selection);
            
            // æ­¥é©Ÿ1: æ¸…ç†LaTeXæ ¼å¼
            let cleanLatex = latex.trim()
                .replace(/\\\[/g, '').replace(/\\\]/g, '')  // ç§»é™¤ \[ \]
                .replace(/\\\(/g, '').replace(/\\\)/g, '')  // ç§»é™¤ \( \)
                .replace(/^\$\$/, '').replace(/\$\$$/, '')  // ç§»é™¤ $$..$$
                .replace(/^\$/, '').replace(/\$$/, '')      // ç§»é™¤ $..$
                .trim();
            
            console.log('   æ¸…ç†å¾ŒLaTeX:', cleanLatex);
            
            // æª¢æŸ¥æ¸…ç†å¾Œçš„LaTeXæ˜¯å¦ç‚ºç©º
            if (!cleanLatex || cleanLatex.length === 0) {
                console.error('âŒ LaTeXå…§å®¹ç‚ºç©ºï¼Œç„¡æ³•æ¸²æŸ“');
                addChatMessage('AI', 'âŒ **è­˜åˆ¥å¤±æ•—**\n\nç„¡æ³•è­˜åˆ¥åœˆé¸å€åŸŸçš„æ•¸å­¸å…¬å¼ã€‚\nå¯èƒ½åŸå› ï¼š\nâ€¢ åœˆé¸äº†å·²ç¶“è½‰æ›éçš„å…¬å¼ï¼ˆè«‹åœˆé¸æ‰‹å¯«å…§å®¹ï¼‰\nâ€¢ AIè­˜åˆ¥å¤±æ•—\nâ€¢ åœ–ç‰‡ä¸æ¸…æ™°');
                isSelecting = false;
                isReadyToSelect = false;
                return;
            }
            
            // æ­¥é©Ÿ2: ä½¿ç”¨KaTeXæ¸²æŸ“LaTeXç‚ºHTML
            // âš ï¸ æ–°è¦å‰‡ï¼šå®¹å™¨å¤§å° = åœˆé¸å¤§å°ï¼ˆä¿è­‰å®Œå…¨è¦†è“‹ï¼‰
            const container = document.createElement('div');
            container.style.cssText = `
                position: absolute;
                left: -9999px;
                width: ${selection.width}px;
                height: ${selection.height}px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: white;
                padding: 0;
                box-sizing: border-box;
                overflow: hidden;
            `;
            document.body.appendChild(container);
            
            console.log('ğŸ“ æ¸²æŸ“è¨­å®š: å®¹å™¨å¤§å° =', selection.width, 'x', selection.height, 'px (å›ºå®š)');
            
            try {
                katex.render(cleanLatex, container, { throwOnError: false, displayMode: true });
                console.log('âœ… KaTeXæ¸²æŸ“æˆåŠŸ');
                
                // æ­¥é©Ÿ3: ä½¿ç”¨html2canvaså°‡HTMLè½‰ç‚ºåœ–ç‰‡ï¼ˆå›ºå®šå°ºå¯¸ï¼‰
                html2canvas(container, { 
                    backgroundColor: 'white', 
                    scale: 2,
                    width: selection.width,
                    height: selection.height
                }).then(canvas2 => {
                    document.body.removeChild(container);
                    
                    const img = new Image();
                    img.onload = () => {
                        console.log('âœ… åœ–ç‰‡è¼‰å…¥æˆåŠŸï¼Œå°ºå¯¸:', img.width, 'x', img.height);
                        
                        // æ­¥é©Ÿ4: ç›´æ¥ä½¿ç”¨åœˆé¸ç¯„åœï¼ˆ1:1 å°æ‡‰ï¼Œä¿è­‰å®Œå…¨è¦†è“‹ï¼‰
                        const x = selection.x;
                        const y = selection.y;
                        const w = selection.width;
                        const h = selection.height;
                        
                        console.log('ğŸ“ ç¹ªè£½åƒæ•¸:');
                        console.log('   åœˆé¸ç¯„åœ:', selection);
                        console.log('   æ¸²æŸ“åœ–ç‰‡:', {width: img.width, height: img.height});
                        console.log('   æœ€çµ‚å°ºå¯¸:', {x, y, w, h});
                        console.log('   âœ… 1:1 å°æ‡‰ï¼Œä¿è­‰å®Œå…¨è¦†è“‹');
                        
                        // æ­¥é©Ÿ5: å…ˆå¾strokesä¸­ç§»é™¤é¸æ“‡å€åŸŸå…§çš„ç­†ç•«
                        // âš ï¸ æ–°è¦å‰‡ï¼šåªåˆªé™¤ã€Œæœ‰é‡ç–Šã€çš„å…§å®¹ï¼Œä¸ç®¡æ©¡çš®æ“¦
                        const newStrokes = [];
                        
                        // è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—å…©å€‹çŸ©å½¢çš„é‡ç–Šé¢ç©ç™¾åˆ†æ¯”
                        function getOverlapRatio(rect1, rect2) {
                            const x_overlap = Math.max(0, Math.min(rect1.x + rect1.width, rect2.x + rect2.width) - Math.max(rect1.x, rect2.x));
                            const y_overlap = Math.max(0, Math.min(rect1.y + rect1.height, rect2.y + rect2.height) - Math.max(rect1.y, rect2.y));
                            const overlapArea = x_overlap * y_overlap;
                            const rect1Area = rect1.width * rect1.height;
                            return rect1Area > 0 ? (overlapArea / rect1Area) : 0;
                        }
                        
                        for (let i = 0; i < strokes.length; i++) {
                            const stroke = strokes[i];
                            let keepStroke = true;
                            
                            if (stroke.tool === 'image') {
                                // åœ–ç‰‡ç­†ç•«ï¼šä½¿ç”¨å¯¦éš›ç¹ªè£½å€åŸŸï¼ˆä¸ä½¿ç”¨åŸåœˆé¸å€ï¼‰
                                // åªè¦ã€Œå¯¦éš›å…¬å¼åœ–ç‰‡ã€æœ‰ 50% ä»¥ä¸Šåœ¨é¸å€å…§ï¼Œå°±åˆªé™¤
                                const imageArea = {
                                    x: stroke.x,
                                    y: stroke.y,
                                    width: stroke.width,
                                    height: stroke.height
                                };
                                
                                const overlapRatio = getOverlapRatio(imageArea, selection);
                                
                                if (overlapRatio > 0.5) {
                                    keepStroke = false;
                                    console.log('ğŸ—‘ï¸  ç§»é™¤é‡ç–Šçš„å…¬å¼:', stroke.id || 'unknown');
                                    console.log('   å…¬å¼ä½ç½®:', `${Math.round(imageArea.x)},${Math.round(imageArea.y)} ${Math.round(imageArea.width)}x${Math.round(imageArea.height)}`);
                                    console.log('   æ–°é¸å€:', `${Math.round(selection.x)},${Math.round(selection.y)} ${Math.round(selection.width)}x${Math.round(selection.height)}`);
                                    console.log('   é‡ç–Šæ¯”ä¾‹:', (overlapRatio * 100).toFixed(1) + '%');
                                } else {
                                    console.log('âœ… ä¿ç•™å…¬å¼:', stroke.id || 'unknown', `(é‡ç–Š ${(overlapRatio * 100).toFixed(1)}% < 50%)`);
                                }
                            } else if (stroke.points) {
                                // æ™®é€šç­†ç•«ï¼šä½¿ç”¨ 50% é–€æª»ï¼ˆèˆ‡åœ–ç‰‡ç­†ç•«ä¸€è‡´ï¼‰
                                const pointsInSelection = stroke.points.filter(p => 
                                    p.x >= selection.x && p.x <= selection.x + selection.width &&
                                    p.y >= selection.y && p.y <= selection.y + selection.height
                                ).length;
                                
                                const overlapRatio = pointsInSelection / stroke.points.length;
                                
                                if (overlapRatio > 0.5) {  // â† 50% ä»¥ä¸Šå°±åˆªé™¤
                                    keepStroke = false;
                                    console.log('ğŸ—‘ï¸  ç§»é™¤é‡ç–Šçš„ç­†ç•«:', Math.round(overlapRatio * 100) + '% (', pointsInSelection, '/', stroke.points.length, ')');
                                } else if (pointsInSelection > 0) {
                                    console.log('âœ… ä¿ç•™ç­†ç•«:', Math.round(overlapRatio * 100) + '% < 50% (', pointsInSelection, '/', stroke.points.length, ')');
                                }
                            }
                            
                            if (keepStroke) {
                                newStrokes.push(stroke);
                            }
                        }
                        
                        // æ›´æ–°strokesæ•¸çµ„
                        strokes.length = 0;
                        strokes.push(...newStrokes);
                        
                        console.log('ğŸ—‘ï¸  å·²ç§»é™¤é¸æ“‡å€åŸŸå…§çš„ç­†ç•«ï¼Œå‰©é¤˜:', strokes.length);
                        
                        // æ­¥é©Ÿ6: æ·»åŠ å…¬å¼åœ–ç‰‡ä½œç‚ºæ–°ç­†ç•«ï¼ˆå¸¶å”¯ä¸€IDå’ŒåŸå§‹è³‡æ–™ï¼‰
                        const formulaId = 'formula_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        const formulaStroke = {
                            tool: 'image',
                            image: img,
                            x: x,
                            y: y,
                            width: w,
                            height: h,
                            // æ·»åŠ å…¬å¼ç‰¹æœ‰å±¬æ€§
                            id: formulaId,
                            type: 'math_formula',
                            originalLatex: cleanLatex,
                            selectionArea: {
                                x: selection.x,
                                y: selection.y,
                                width: selection.width,
                                height: selection.height
                            },
                            timestamp: Date.now(),
                            editable: true  // æ¨™è¨˜ç‚ºå¯ç¨ç«‹ç·¨è¼¯
                        };
                        
                        strokes.push(formulaStroke);
                        
                        // æ·»åŠ åˆ°å…¬å¼ç®¡ç†ç³»çµ±
                        formulaObjects.set(formulaId, {
                            stroke: formulaStroke,
                            metadata: {
                                createdAt: Date.now(),
                                originalSelection: selection,
                                replacedStrokes: strokes.length - newStrokes.length,  // è¨˜éŒ„æ›¿æ›äº†å¤šå°‘ç­†ç•«
                                layer: layerOrder.length
                            }
                        });
                        layerOrder.push(formulaId);
                        
                        console.log('âœ… å…¬å¼å·²æ·»åŠ ç‚ºå¯ç·¨è¼¯ç­†ç•«:', formulaId);
                        console.log('ğŸ“‹ ç•¶å‰å…¬å¼æ•¸é‡:', formulaObjects.size);
                        
                        console.log('âœ… å…¬å¼å·²æ·»åŠ ç‚ºç­†ç•«ï¼Œç¸½æ•¸:', strokes.length);
                        
                        // æ­¥é©Ÿ7: é‡ç¹ªæ•´å€‹ç•«å¸ƒ
                        redrawCanvas();
                        console.log('âœ… ç•«å¸ƒå·²é‡ç¹ª');
                        
                        // æ­¥é©Ÿ8: æ¸…é™¤é¸æ“‡ç‹€æ…‹
                        isSelecting = false;
                        isReadyToSelect = false;
                        selectionStart = {x: 0, y: 0};
                        selectionEnd = {x: 0, y: 0};
                        currentSelection = null;
                        window.currentSelectionData = null;
                        
                        // æ­¥é©Ÿ9: é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                        addChatMessage('AI', `âœ… **æ•¸å­¸å…¬å¼è½‰æ›å®Œæˆï¼**\n\nğŸ“ LaTeX: \`${cleanLatex}\`\nğŸ¨ å·²æ›¿æ›åˆ°ç•«å¸ƒä¸Š`);
                        console.log('ğŸ‰ renderMathFormula å®Œæˆï¼');
                    };
                    img.src = canvas2.toDataURL();
                }).catch(err => {
                    document.body.removeChild(container);
                    console.error('âŒ html2canvaséŒ¯èª¤:', err);
                    addChatMessage('AI', 'âŒ æ¸²æŸ“å¤±æ•—');
                });
                
            } catch (err) {
                document.body.removeChild(container);
                console.error('âŒ KaTeXéŒ¯èª¤:', err);
                addChatMessage('AI', `âŒ LaTeXèªæ³•éŒ¯èª¤: ${err.message}`);
            }
        }
        
        // è™•ç†å¿ƒæ™ºåœ–åŠŸèƒ½ï¼ˆæš«æ™‚ç°¡åŒ–å¯¦ç¾ï¼‰
        function processMindMap(selectionData) {
            addChatMessage('AI', 'ğŸ—ºï¸ å¿ƒæ™ºåœ–åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...\n\nç•¶å‰é¸ä¸­å€åŸŸå°‡åœ¨æœªä¾†ç‰ˆæœ¬ä¸­æ”¯æŒè½‰æ›ç‚ºå¯ç·¨è¼¯çš„å¿ƒæ™ºåœ–ã€‚');
            // æ¸…é™¤é¸æ“‡æ•¸æ“š
            window.currentSelectionData = null;
        }
        
        // ===== å…¨å±€è®Šé‡è²æ˜ =====
        let canvas = null;
        let ctx = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentTool = 'pen';
        let currentColor = '#2c3e50';
        let currentSize = 5;
        let strokes = []; // è¨˜éŒ„æ‰€æœ‰ç­†ç•«æ•¸æ“š
        let currentStroke = null; // ç•¶å‰æ­£åœ¨ç¹ªè£½çš„ç­†ç•«
        let images = []; // è¨˜éŒ„æ‰€æœ‰æ’å…¥çš„åœ–ç‰‡æ•¸æ“š
        
        // å…¬å¼ç®¡ç†ç³»çµ±
        let formulaObjects = new Map(); // å­˜å„²æ‰€æœ‰æ¸²æŸ“çš„å…¬å¼å°è±¡ {id: {stroke, metadata}}
        let layerOrder = []; // è¨˜éŒ„æ‰€æœ‰å°è±¡çš„å±¤æ¬¡é †åº
        
        // å…¬å¼ç®¡ç†å‡½æ•¸
        function getFormulaAtPoint(x, y) {
            // å¾æœ€ä¸Šå±¤é–‹å§‹æª¢æŸ¥ï¼ˆæœ€å¾Œæ·»åŠ çš„å„ªå…ˆï¼‰
            for (let i = layerOrder.length - 1; i >= 0; i--) {
                const formulaId = layerOrder[i];
                const formulaObj = formulaObjects.get(formulaId);
                if (formulaObj && formulaObj.stroke) {
                    const stroke = formulaObj.stroke;
                    if (x >= stroke.x && x <= stroke.x + stroke.width &&
                        y >= stroke.y && y <= stroke.y + stroke.height) {
                        return {id: formulaId, ...formulaObj};
                    }
                }
            }
            return null;
        }
        
        function removeFormula(formulaId) {
            if (formulaObjects.has(formulaId)) {
                // å¾strokesä¸­ç§»é™¤
                const formulaObj = formulaObjects.get(formulaId);
                const strokeIndex = strokes.indexOf(formulaObj.stroke);
                if (strokeIndex > -1) {
                    strokes.splice(strokeIndex, 1);
                }
                
                // å¾ç®¡ç†ç³»çµ±ä¸­ç§»é™¤
                formulaObjects.delete(formulaId);
                const layerIndex = layerOrder.indexOf(formulaId);
                if (layerIndex > -1) {
                    layerOrder.splice(layerIndex, 1);
                }
                
                redrawCanvas();
                console.log('ğŸ—‘ï¸  å·²ç§»é™¤å…¬å¼:', formulaId);
                return true;
            }
            return false;
        }
        
        // åœˆé¸åŠŸèƒ½è®Šé‡
        let isSelecting = false; // æ˜¯å¦è™•æ–¼åœˆé¸ç‹€æ…‹
        let isReadyToSelect = false; // æº–å‚™åœˆé¸ï¼ˆé»æ“ŠæŒ‰éˆ•å¾Œï¼Œç­‰å¾…ç”¨æˆ¶åœ¨ç•«å¸ƒä¸Šé»æ“Šï¼‰
        let selectionStart = {x: 0, y: 0};
        let selectionEnd = {x: 0, y: 0};
        let currentSelection = null;
        
        // é¸å–æ“ä½œçµ„ç‹€æ…‹ç®¡ç†
        let selectionOperation = null; // 'select', 'move', null
        
        // æŒ‰éˆ•è®Šé‡ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰
        let selectAreaBtn = null;
        let moveBtn = null;
        let scaleBtn = null;
        let deleteBtn = null;
        
        // ç§»å‹•åŠŸèƒ½è®Šé‡
        let isMoving = false; // ç§»å‹•æ¨¡å¼ç‹€æ…‹
        let isDragging = false; // æ˜¯å¦æ­£åœ¨æ‹–æ‹½ç§»å‹•
        let moveStartPoint = {x: 0, y: 0}; // ç§»å‹•èµ·å§‹é»
        let selectedItems = []; // é¸ä¸­çš„é …ç›®é™£åˆ—
        
        // ===== é¸å–æ“ä½œçµ„ç®¡ç†å‡½æ•¸ =====
        function setSelectionOperation(op) {
            // å…ˆå–æ¶ˆç•¶å‰æ“ä½œ
            if (selectionOperation === 'select') {
                isReadyToSelect = false;
                selectAreaBtn.style.background = '#3498db';
                addChatMessage('AI', 'âŒ **å·²å–æ¶ˆåœˆé¸æ¨¡å¼**');
            } else if (selectionOperation === 'move') {
                isMoving = false;
                selectedItems = []; // æ¸…ç©ºé¸ä¸­é …ç›®
                moveBtn.style.background = '#9b59b6';
                addChatMessage('AI', 'âŒ **å·²å–æ¶ˆç§»å‹•æ¨¡å¼**');
                updateCanvasCursor(); // æ›´æ–°æ¸¸æ¨™
            } else if (selectionOperation === 'scale') {
                isScaling = false;
                scaleBtn.style.background = '#f39c12';
                addChatMessage('AI', 'âŒ **å·²å–æ¶ˆç¸®æ”¾æ¨¡å¼**');
            } else if (selectionOperation === 'delete') {
                isDeleting = false;
                deleteBtn.style.background = '#e74c3c';
                addChatMessage('AI', 'âŒ **å·²å–æ¶ˆåˆªé™¤æ¨¡å¼**');
            }
            
            // è¨­ç½®æ–°æ“ä½œ
            selectionOperation = op;
            
            if (op === 'select') {
                isReadyToSelect = true;
                selectAreaBtn.style.background = '#e74c3c';
                addChatMessage('AI', 'ğŸ”² **åœˆé¸æ¨¡å¼å·²æ¿€æ´»**\n\nè«‹åœ¨ç•«å¸ƒä¸Šæ‹–å‹•æ»‘é¼ åœˆé¸å€åŸŸã€‚');
            } else if (op === 'move') {
                isMoving = true;
                moveBtn.style.background = '#e74c3c';
                addChatMessage('AI', 'ğŸ–ï¸ **ç§»å‹•æ¨¡å¼å·²æ¿€æ´»**\n\nè«‹åœˆé¸è¦ç§»å‹•çš„å…§å®¹ï¼Œç„¶å¾Œæ‹–æ‹½ç§»å‹•ã€‚');
                updateCanvasCursor(); // æ›´æ–°æ¸¸æ¨™
            } else if (op === 'scale') {
                isScaling = true;
                scaleBtn.style.background = '#e74c3c';
                addChatMessage('AI', 'ğŸ” **ç¸®æ”¾æ¨¡å¼å·²æ¿€æ´»**\n\nè«‹åœˆé¸è¦ç¸®æ”¾çš„å€åŸŸï¼Œç„¶å¾Œæ‹–æ‹½ç¸®æ”¾ã€‚');
            } else if (op === 'delete') {
                isDeleting = true;
                deleteBtn.style.background = '#e74c3c';
                addChatMessage('AI', 'ğŸ—‘ï¸ **åˆªé™¤æ¨¡å¼å·²æ¿€æ´»**\n\nè«‹åœˆé¸è¦åˆªé™¤çš„å€åŸŸï¼Œç„¶å¾Œæ‹–æ‹½åˆªé™¤ã€‚');
            }
        }
        
        // ===== å…¨å±€ç¹ªåœ–å‡½æ•¸ =====
            
            // ç§»å‹•é¸ä¸­é …ç›®å‡½æ•¸
            function moveSelectedItems(deltaX, deltaY) {
                console.log('ğŸ”„ ç§»å‹•é …ç›®: Î”x=' + deltaX + ', Î”y=' + deltaY);

                selectedItems.forEach(item => {
                    // ç§»å‹•åœ–ç‰‡é¡å…§å®¹
                    if (item.tool === 'image') {
                        // æ›´æ–°selectedItemsä¸­çš„æ•¸æ“š
                        item.x += deltaX;
                        item.y += deltaY;
                        // æ›´æ–°åŸå§‹imagesæ•¸çµ„ä¸­çš„æ•¸æ“š
                        if (item.index >= 0 && item.index < images.length) {
                            images[item.index].x = item.x;
                            images[item.index].y = item.y;
                        }
                        console.log('  ç§»å‹•åœ–ç‰‡:', item.x.toFixed(1), item.y.toFixed(1));
                    }
                    // ç§»å‹•ç­†ç•«é¡å…§å®¹
                    else if (item.points) {
                        // æ›´æ–°selectedItemsä¸­çš„æ•¸æ“š
                        item.points.forEach(point => {
                            point.x += deltaX;
                            point.y += deltaY;
                        });
                        // æ›´æ–°åŸå§‹strokesæ•¸çµ„ä¸­çš„æ•¸æ“š
                        if (item.index >= 0 && item.index < strokes.length) {
                            strokes[item.index].points = item.points;
                        }
                        console.log('  ç§»å‹•ç­†ç•«:', item.points.length + 'é»');
                    }
                });

                // ç«‹å³é‡ç¹ªç•«å¸ƒ
                redrawCanvas();
            }
            
            // ç²å–é¸å€ä¸­çš„é …ç›® (åœ–ç‰‡å’Œç­†ç•«)
            function getItemsInSelection(selection) {
                const items = [];
                const overlapThreshold = 0.3; // 30% é‡ç–Šåº¦é˜ˆå€¼

                // æª¢æŸ¥æ‰€æœ‰åœ–ç‰‡
                images.forEach(image => {
                    const overlapRatio = getOverlapRatio(
                        {x: image.x, y: image.y, width: image.width, height: image.height},
                        selection
                    );
                    if (overlapRatio >= overlapThreshold) {
                        items.push({
                            tool: 'image',
                            index: images.indexOf(image),
                            x: image.x,
                            y: image.y,
                            width: image.width,
                            height: image.height,
                            imageData: image.imageData
                        });
                    }
                });

                // æª¢æŸ¥æ‰€æœ‰ç­†ç•«
                strokes.forEach((stroke, strokeIndex) => {
                    // ç¢ºä¿strokeæœ‰pointså±¬æ€§ä¸”ä¸ç‚ºç©º
                    if (!stroke.points || !Array.isArray(stroke.points) || stroke.points.length === 0) {
                        return; // è·³éç„¡æ•ˆçš„stroke
                    }

                    // è¨ˆç®—ç­†ç•«çš„é‚Šç•Œæ¡†
                    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                    stroke.points.forEach(point => {
                        minX = Math.min(minX, point.x);
                        minY = Math.min(minY, point.y);
                        maxX = Math.max(maxX, point.x);
                        maxY = Math.max(maxY, point.y);
                    });

                    if (minX !== Infinity) {
                        const strokeBounds = {
                            x: minX,
                            y: minY,
                            width: maxX - minX,
                            height: maxY - minY
                        };

                        const overlapRatio = getOverlapRatio(strokeBounds, selection);
                        if (overlapRatio >= overlapThreshold) {
                            items.push({
                                tool: 'stroke',
                                index: strokeIndex,
                                points: stroke.points,
                                color: stroke.color,
                                size: stroke.size,
                                bounds: strokeBounds
                            });
                        }
                    }
                });

                return items;
            }

            // è¨ˆç®—å…©å€‹çŸ©å½¢é‡ç–Šæ¯”ä¾‹çš„å·¥å…·å‡½æ•¸
            function getOverlapRatio(rect1, rect2) {
                const overlapX = Math.max(0, Math.min(rect1.x + rect1.width, rect2.x + rect2.width) - Math.max(rect1.x, rect2.x));
                const overlapY = Math.max(0, Math.min(rect1.y + rect1.height, rect2.y + rect2.height) - Math.max(rect1.y, rect2.y));
                const overlapArea = overlapX * overlapY;

                const rect1Area = rect1.width * rect1.height;
                const rect2Area = rect2.width * rect2.height;

                // è¿”å›ç›¸å°æ–¼è¼ƒå°çŸ©å½¢çš„é‡ç–Šæ¯”ä¾‹
                const smallerArea = Math.min(rect1Area, rect2Area);
                return smallerArea > 0 ? overlapArea / smallerArea : 0;
            }

            // ç¹ªåœ–å‡½æ•¸ (ç´”ç²¹ç•«ç•«)
            function draw(e) {
                if (!isDrawing) return;

                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.lineWidth = currentSize;
                ctx.strokeStyle = currentColor;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
                
                // æ·»åŠ é»åˆ°ç•¶å‰ç­†ç•«
                if (currentStroke) {
                    currentStroke.points.push({x: x, y: y});
                }
            }
            
        // é–‹å§‹ç¹ªåœ–
            function startDrawing(e) {
                if (!canvas || !ctx) return; // æª¢æŸ¥åˆå§‹åŒ–
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // ç¢ºä¿é¸æ“‡æ¨¡å¼é—œé–‰ï¼Œé–‹å§‹ç¹ªåœ–
                isSelecting = false;
                isDrawing = true;
                lastX = x;
                lastY = y;
                
                // é–‹å§‹æ–°ç­†ç•«
                currentStroke = {
                    tool: currentTool,
                    color: currentColor,
                    size: currentSize,
                    points: [{x: lastX, y: lastY}]
                };
            }
            
            // åœæ­¢ç¹ªåœ–
            function stopDrawing() {
                if (!canvas || !ctx) return;
                
                if (isDrawing && currentStroke) {
                    strokes.push(currentStroke);
                    currentStroke = null;
                }
                isDrawing = false;
            }
            
        function initializeApp() {
            try {
                console.log('Starting app initialization...');
                
                // ç²å–ç•«å¸ƒå’Œä¸Šä¸‹æ–‡
                canvas = document.getElementById('drawing-canvas');
                if (!canvas) {
                    console.error('Canvas element not found!');
                    return;
                }
                ctx = canvas.getContext('2d');
                
                if (!ctx) {
                    console.error('Failed to get canvas context!');
                    return;
                }
            
            // è¨­å®šç•«å¸ƒå¤§å°
            function resizeCanvas() {
                if (!canvas) return;
                const container = canvas.parentElement;
                canvas.width = container.clientWidth - 4; // æ¸›å»é‚Šæ¡†
                canvas.height = container.clientHeight - 4;
                console.log('Canvas resized:', canvas.width, 'x', canvas.height);
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            

            
            // ç¶å®šç•«å¸ƒäº‹ä»¶ - çµ±ä¸€äº‹ä»¶è™•ç†
            canvas.addEventListener('mousedown', handleCanvasMouseDown);
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseup', handleCanvasMouseUp);
            canvas.addEventListener('mouseout', handleCanvasMouseUp);
            
            // è§¸æ§äº‹ä»¶æ”¯æ´
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                canvas.dispatchEvent(new MouseEvent('mouseup', {}));
            });
            
            // åœˆé¸æŒ‰éˆ• - è¡Œç‚ºé¡ä¼¼å·¥å…·åˆ‡æ›
            selectAreaBtn = document.getElementById('select-area-btn');
            if (selectAreaBtn) {
                selectAreaBtn.addEventListener('click', function() {
                    if (selectionOperation === 'select') {
                        setSelectionOperation(null); // å–æ¶ˆåœˆé¸
                    } else {
                        setSelectionOperation('select'); // æ¿€æ´»åœˆé¸
                    }
                });
            }
            
            // å·¥å…·æŒ‰éˆ•
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.addEventListener('click', function() {
                    // å–æ¶ˆåœˆé¸æ¨¡å¼ï¼ˆå¦‚æœæ¿€æ´»ï¼‰
                    if (isReadyToSelect && selectAreaBtn) {
                        isReadyToSelect = false;
                        selectAreaBtn.style.background = '#3498db';  // æ¢å¾©åŸè‰²
                        console.log('âŒ åˆ‡æ›å·¥å…·ï¼Œå–æ¶ˆåœˆé¸æ¨¡å¼');
                    }
                    
                    // å·¥å…·åˆ‡æ›
                    document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTool = this.dataset.tool;
                    console.log('Tool changed to:', currentTool);
                });
            });
            
            // é¡è‰²é¸æ“‡å™¨
            const colorPicker = document.getElementById('color-picker');
            if (colorPicker) {
                colorPicker.addEventListener('change', function() {
                    currentColor = this.value;
                    console.log('Color changed to:', currentColor);
                });
            } else {
                console.warn('color-picker not found, skipping color picker setup');
            }
            
            // é¡è‰²æ¨£æœ¬
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', function() {
                    currentColor = this.dataset.color;
                    colorPicker.value = currentColor;
                    console.log('Color changed to:', currentColor);
                });
            });
            
            // ç­†åˆ·å¤§å°
            const sizeSlider = document.getElementById('size-slider');
            const sizeDisplay = document.getElementById('size-display');
            if (sizeSlider && sizeDisplay) {
                sizeSlider.addEventListener('input', function() {
                    currentSize = parseInt(this.value);
                    sizeDisplay.textContent = currentSize + 'px';
                });
            } else {
                console.warn('size-slider or size-display not found, skipping size setup');
            }
            
            // æ¸…é™¤æŒ‰éˆ•
            const clearBtn = document.getElementById('clear-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    if (!canvas || !ctx) {
                        console.error('Canvas not initialized');
                        return;
                    }
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    strokes = []; // æ¸…ç©ºç­†ç•«è¨˜éŒ„
                    console.log('Canvas cleared');
                    addChatMessage('AI', 'ç•«å¸ƒå·²æ¸…é™¤ï¼è«‹ç¹¼çºŒæ‚¨çš„å‰µä½œã€‚âœ¨');
                });
            } else {
                console.warn('clear-btn not found, skipping clear button setup');
            }
            
            // åˆ†æåœ–åƒæŒ‰éˆ•
            const analyzeBtn = document.getElementById('analyze-btn');
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', function() {
                    analyzeDrawing();
                });
            } else {
                console.warn('analyze-btn not found, skipping analyze button setup');
            }
            
            // å„²å­˜æŒ‰éˆ• (PNGä¸‹è¼‰)
            const saveBtn = document.getElementById('save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                try {
                    if (!canvas || !ctx) {
                        addChatMessage('AI', 'âŒ ç•«å¸ƒæœªåˆå§‹åŒ–ï¼Œç„¡æ³•ä¿å­˜ã€‚');
                        return;
                    }
                    
                    // æª¢æŸ¥ç•«å¸ƒæ˜¯å¦æœ‰å…§å®¹
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const pixels = imageData.data;
                    let hasContent = false;
                    for (let i = 3; i < pixels.length; i += 4) {
                        if (pixels[i] > 0) { // alpha channel
                            hasContent = true;
                            break;
                        }
                    }
                    
                    if (!hasContent) {
                        addChatMessage('AI', 'ğŸ“ ç•«å¸ƒæ˜¯ç©ºçš„ï¼è«‹å…ˆç•«ä¸€äº›å…§å®¹å†ä¸‹è¼‰ã€‚');
                        return;
                    }
                    
                    const dataURL = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'ui-corework-drawing-' + new Date().getTime() + '.png';
                    link.href = dataURL;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    console.log('Drawing saved as PNG');
                    addChatMessage('AI', 'ğŸ¨ æ‚¨çš„ä½œå“å·²ä¸‹è¼‰ç‚ºPNGæª”æ¡ˆï¼');
                } catch (error) {
                    console.error('Save PNG error:', error);
                    addChatMessage('AI', 'âŒ PNGä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
                }
                });
            } else {
                console.warn('save-btn not found, skipping PNG save setup');
            }
            
            // ä¿å­˜åˆ°é …ç›®æŒ‰éˆ•
            const saveToProjectBtn = document.getElementById('save-to-project-btn');
            if (saveToProjectBtn) {
                saveToProjectBtn.addEventListener('click', function() {
                    saveDrawingToProject();
                });
            } else {
                console.warn('save-to-project-btn not found, skipping save-to-project setup');
            }
            
            // èŠå¤©åŠŸèƒ½
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            if (!chatMessages || !chatInput || !sendBtn) {
                console.warn('Chat elements missing, chat will be disabled');
            }
            

            
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                addChatMessage('æ‚¨', message);
                chatInput.value = '';
                
                // æ™ºèƒ½ AI å›æ‡‰
                setTimeout(() => {
                    processAIMessage(message);
                }, 800);
            }
            
            // AI è¨Šæ¯è™•ç†å‡½æ•¸
            function processAIMessage(userMessage) {
                const message = userMessage.toLowerCase();
                
                // æª¢æŸ¥æ˜¯å¦è¦æ±‚æ•¸å­¸å…¬å¼è½‰æ›
                if (message.includes('math') || message.includes('å…¬å¼') || message.includes('æ•¸å­¸')) {
                    if (window.currentSelectionData) {
                        processMathFormula(window.currentSelectionData);
                        return;
                    } else {
                        addChatMessage('AI', 'è«‹å…ˆä½¿ç”¨é¸æ“‡å·¥å…·ï¼ˆğŸ”² é¸ï¼‰åœ¨ç•«å¸ƒä¸Šåœˆé¸åŒ…å«æ•¸å­¸å…¬å¼çš„å€åŸŸã€‚');
                        return;
                    }
                }
                
                // æª¢æŸ¥æ˜¯å¦è¦æ±‚å¿ƒæ™ºåœ–ç·¨è¼¯
                if (message.includes('mindmap') || message.includes('å¿ƒæ™ºåœ–') || message.includes('è…¦åœ–')) {
                    if (window.currentSelectionData) {
                        processMindMap(window.currentSelectionData);
                        return;
                    } else {
                        addChatMessage('AI', 'è«‹å…ˆä½¿ç”¨é¸æ“‡å·¥å…·ï¼ˆğŸ”² é¸ï¼‰åœ¨ç•«å¸ƒä¸Šåœˆé¸è¦è½‰æ›ç‚ºå¿ƒæ™ºåœ–çš„å€åŸŸã€‚');
                        return;
                    }
                }
                
                // æª¢æŸ¥æ˜¯å¦è¦æ±‚åˆ†æåœ–åƒ
                if (message.includes('åˆ†æ') || message.includes('è¾¨è­˜') || message.includes('è­˜åˆ¥') || message.includes('é€™æ˜¯ä»€éº¼')) {
                    analyzeDrawing();
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦è¦æ±‚å°‹æ‰¾ç¯„ä¾‹
                if (message.includes('ç¯„ä¾‹') || message.includes('ä¾‹å­') || message.includes('åƒè€ƒ') || message.includes('æ‰¾') || message.includes('æœå°‹') || message.includes('ä¸Šç¶²')) {
                    const keywords = extractKeywords(message);
                    findDesignExamples(keywords);
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦è¦æ±‚æ•™å­¸
                if (message.includes('æ•™') || message.includes('æ€éº¼') || message.includes('å¦‚ä½•')) {
                    provideDrawingTutorial(message);
                    return;
                }
                
                // é è¨­æ™ºèƒ½å›æ‡‰
                const intelligentResponses = [
                    'æˆ‘çœ‹åˆ°æ‚¨çš„è¨Šæ¯äº†ï¼æ‚¨å¯ä»¥ï¼š\nğŸ¨ ç¹¼çºŒåœ¨ç•«å¸ƒä¸Šå‰µä½œ\nğŸ” é»æ“Šã€Œåˆ†æåœ–åƒã€è®“æˆ‘åˆ†ææ‚¨çš„ä½œå“\nğŸ“š é»æ“Šã€Œå°‹æ‰¾ç¯„ä¾‹ã€ç²å–è¨­è¨ˆéˆæ„Ÿ',
                    'å¾ˆæ£’çš„æƒ³æ³•ï¼å¦‚æœæ‚¨éœ€è¦æˆ‘åˆ†æç•¶å‰çš„ç¹ªåœ–ï¼Œè«‹é»æ“Šã€Œåˆ†æåœ–åƒã€æŒ‰éˆ•ã€‚',
                    'æ‚¨å¯ä»¥å‘Šè¨´æˆ‘æ‚¨æƒ³è¦ç•«ä»€éº¼ï¼Œæˆ‘å¯ä»¥ç‚ºæ‚¨æ‰¾åˆ°ç›¸é—œçš„è¨­è¨ˆç¯„ä¾‹å’Œæ•™å­¸ã€‚',
                    'è©¦è©¦çœ‹åœ¨ç•«å¸ƒä¸Šç•«ä¸€äº›å½¢ç‹€ï¼Œç„¶å¾Œè®“æˆ‘åˆ†æä¸¦æä¾›æ”¹é€²å»ºè­°ï¼',
                    'å¦‚æœæ‚¨æƒ³è¦ç‰¹å®šçš„è¨­è¨ˆéˆæ„Ÿï¼Œè«‹å‘Šè¨´æˆ‘æ‚¨è¦è¨­è¨ˆä»€éº¼é¡å‹çš„ç•Œé¢å…ƒç´ ã€‚'
                ];
                const response = intelligentResponses[Math.floor(Math.random() * intelligentResponses.length)];
                addChatMessage('AI', response);
            }
            
            // æå–é—œéµè©
            function extractKeywords(message) {
                const uiElements = ['æŒ‰éˆ•', 'button', 'è¡¨å–®', 'form', 'å°èˆª', 'nav', 'å¡ç‰‡', 'card', 'åœ–æ¨™', 'icon', 'èœå–®', 'menu'];
                const found = uiElements.filter(keyword => message.includes(keyword));
                return found.length > 0 ? found[0] : 'ç•Œé¢è¨­è¨ˆ';
            }
            
            // ä¿å­˜ç¹ªåœ–åˆ°é …ç›®
            function saveDrawingToProject() {
                if (!canvas || !ctx) {
                    addChatMessage('AI', 'âŒ ç•«å¸ƒæœªåˆå§‹åŒ–ï¼Œç„¡æ³•ä¿å­˜ã€‚');
                    return;
                }
                
                // æª¢æŸ¥ç•«å¸ƒæ˜¯å¦æœ‰å…§å®¹ (æ›´å¯é çš„æ–¹æ³•)
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                let hasContent = false;
                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] > 0) { // alpha channel
                        hasContent = true;
                        break;
                    }
                }
                
                if (!hasContent) {
                    addChatMessage('AI', 'ğŸ“ ç•«å¸ƒæ˜¯ç©ºçš„ï¼è«‹å…ˆåœ¨ç•«å¸ƒä¸Šç•«ä¸€äº›å…§å®¹å†ä¿å­˜ã€‚');
                    return;
                }
                
                addChatMessage('AI', 'ğŸ’¾ æ­£åœ¨ä¿å­˜æ‚¨çš„ç¹ªåœ–åˆ°é …ç›®...');
                
                try {
                    // æº–å‚™ç¹ªåœ–æ•¸æ“š
                    const drawingData = {
                        id: 'drawing_' + new Date().getTime(),
                        title: 'Drawing ' + new Date().toLocaleString(),
                        image_data: canvas.toDataURL('image/png'),
                        description: 'ç”¨æˆ¶ç¹ªè£½çš„è¨­è¨ˆè‰åœ–',
                        tags: ['drawing', 'sketch', 'ui-design'],
                        strokes: strokes || [],
                        canvas: {
                            width: canvas.width,
                            height: canvas.height
                        },
                        metadata: {
                            created_at: new Date().toISOString(),
                            tools_used: ['pen', 'eraser']
                        }
                    };
                    
                    // ç™¼é€åˆ°å¾Œç«¯
                    fetch('/api/drawings', {
                        method: 'POST',  
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(drawingData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ç¶²è·¯å›æ‡‰éŒ¯èª¤: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(result => {
                        if (result.id) {
                            console.log('Drawing saved to project:', result);
                            addChatMessage('AI', 'âœ… æ‚¨çš„ç¹ªåœ–å·²æˆåŠŸä¿å­˜åˆ°é …ç›®ï¼ID: ' + result.id);
                        } else {
                            console.error('Failed to save drawing:', result);
                            addChatMessage('AI', 'âŒ ä¿å­˜å¤±æ•—ï¼š' + (result.message || result.detail || 'æœªçŸ¥éŒ¯èª¤'));
                        }
                    })
                    .catch(error => {
                        console.error('Error saving drawing:', error);
                        addChatMessage('AI', 'âŒ ä¿å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                    });
                } catch (error) {
                    console.error('Error preparing drawing data:', error);
                    addChatMessage('AI', 'âŒ æº–å‚™è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                }
            }
            
            // åˆ†æç¹ªåœ– - çœŸå¯¦ AI åˆ†æ
            function analyzeDrawing() {
                if (!canvas || !ctx) {
                    addChatMessage('AI', 'âŒ ç•«å¸ƒæœªåˆå§‹åŒ–ï¼Œç„¡æ³•åˆ†æã€‚');
                    return;
                }
                
                addChatMessage('AI', 'ğŸ” æ­£åœ¨æº–å‚™åœ–åƒé€²è¡Œ AI åˆ†æ...');
                
                // ç²å–ç•«å¸ƒæ•¸æ“š
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å…§å®¹
                let hasContent = false;
                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] > 0) { // alpha channel
                        hasContent = true;
                        break;
                    }
                }
                
                if (!hasContent) {
                    addChatMessage('AI', 'ğŸ“ æˆ‘çœ‹åˆ°ç•«å¸ƒæ˜¯ç©ºçš„ï¼è«‹å…ˆåœ¨ç•«å¸ƒä¸Šç•«ä¸€äº›å…§å®¹ï¼Œç„¶å¾Œæˆ‘å°±å¯ä»¥ç‚ºæ‚¨é€²è¡Œ AI åˆ†æäº†ã€‚');
                    return;
                }
                
                // å°‡ç•«å¸ƒè½‰æ›ç‚ºåœ–ç‰‡æ•¸æ“š
                // å…ˆå¡«å……ç™½è‰²èƒŒæ™¯ï¼Œé¿å…é€æ˜èƒŒæ™¯å½±éŸ¿ AI è­˜åˆ¥
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
                
                const imageDataURL = canvas.toDataURL('image/png');
                
                addChatMessage('AI', 'ğŸ¤– æ­£åœ¨èª¿ç”¨ AI æ¨¡å‹åˆ†ææ‚¨çš„ç¹ªåœ–...');
                
                // ç™¼é€åˆ°å¾Œç«¯é€²è¡ŒçœŸå¯¦ AI åˆ†æ
                fetch('/api/analyze-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_data: imageDataURL,
                        prompt: "è«‹åˆ†æé€™å€‹UIè¨­è¨ˆè‰åœ–ï¼Œè­˜åˆ¥å…¶ä¸­çš„å…ƒç´ ï¼ˆå¦‚æŒ‰éˆ•ã€è¡¨å–®ã€å°èˆªç­‰ï¼‰ï¼Œè©•ä¼°è¨­è¨ˆçš„å„ªç¼ºé»ï¼Œä¸¦æä¾›å…·é«”çš„æ”¹é€²å»ºè­°ã€‚"
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        addChatMessage('AI', 'ğŸ¨ **AI åœ–åƒåˆ†æçµæœï¼š**\n\n' + result.analysis);
                        
                        // å¦‚æœæœ‰ç›¸é—œç¯„ä¾‹æ¨è–¦
                        if (result.suggested_examples) {
                            setTimeout(() => {
                                addChatMessage('AI', 'ï¿½ æ ¹æ“šåˆ†æçµæœï¼Œè®“æˆ‘ç‚ºæ‚¨æ¨è–¦ç›¸é—œçš„è¨­è¨ˆç¯„ä¾‹...');
                                displayRelatedExamples(result.suggested_examples);
                            }, 1500);
                        }
                    } else {
                        addChatMessage('AI', 'âŒ æŠ±æ­‰ï¼ŒAI åˆ†æé‡åˆ°äº†å•é¡Œï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤') + '\n\nğŸ“ ç›®å‰æä¾›åŸºæœ¬åˆ†æä½œç‚ºæ›¿ä»£...');
                        performBasicAnalysis();
                    }
                })
                .catch(error => {
                    console.error('AI åˆ†æéŒ¯èª¤:', error);
                    addChatMessage('AI', 'âŒ é€£æ¥ AI åˆ†ææœå‹™å¤±æ•—ï¼Œæä¾›åŸºæœ¬åˆ†æä½œç‚ºæ›¿ä»£...');
                    performBasicAnalysis();
                });
            }
            
            // åŸºæœ¬åˆ†æä½œç‚ºå¾Œå‚™æ–¹æ¡ˆ
            function performBasicAnalysis() {
                if (!canvas || !ctx) {
                    addChatMessage('AI', 'âŒ ç•«å¸ƒæœªåˆå§‹åŒ–ï¼Œç„¡æ³•é€²è¡ŒåŸºæœ¬åˆ†æã€‚');
                    return;
                }
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                
                let colorCount = new Set();
                let pixelCount = 0;
                
                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] > 0) {
                        const r = pixels[i-3], g = pixels[i-2], b = pixels[i-1];
                        colorCount.add(`${r}-${g}-${b}`);
                        pixelCount++;
                    }
                }
                
                let analysis = 'ğŸ“Š **åŸºæœ¬åœ–åƒåˆ†æï¼š**\n\n';
                analysis += `ğŸ¨ æª¢æ¸¬åˆ° ${colorCount.size} ç¨®é¡è‰²\n`;
                analysis += `ğŸ“ ç¹ªè£½äº†ç´„ ${Math.round(pixelCount / 1000)} k å€‹åƒç´ \n\n`;
                
                analysis += 'ğŸ’¡ **è¨­è¨ˆå»ºè­°ï¼š**\n';
                if (colorCount.size === 1) {
                    analysis += 'â€¢ è€ƒæ…®å¢åŠ å°æ¯”è‰²ä¾†çªå‡ºé‡è¦å…ƒç´ \n';
                } else if (colorCount.size > 8) {
                    analysis += 'â€¢ è‰²å½©è¼ƒå¤šï¼Œå»ºè­°çµ±ä¸€è‰²å½©æ–¹æ¡ˆ\n';
                }
                analysis += 'â€¢ å¯ä»¥å˜—è©¦æ·»åŠ ä¸€äº›å¹¾ä½•å½¢ç‹€ä¾†çµ„ç¹”ä½ˆå±€\n';
                analysis += 'â€¢ è€ƒæ…®æ·»åŠ æ–‡å­—æ¨™ç±¤ä¾†èªªæ˜åŠŸèƒ½\n\n';
                analysis += 'ğŸ”§ **å‡ç´šæç¤ºï¼š** é€£æ¥ AI æ¨¡å‹å¾Œå¯ç²å¾—æ›´è©³ç´°çš„è¨­è¨ˆåˆ†æï¼';
                
                addChatMessage('AI', analysis);
            }
            
            // å°‹æ‰¾è¨­è¨ˆç¯„ä¾‹å‡½æ•¸
            function findDesignExamples(keywords) {
                addChatMessage('AI', `ğŸ” æ­£åœ¨ç‚ºæ‚¨æœå°‹ã€Œ${keywords}ã€ç›¸é—œçš„è¨­è¨ˆç¯„ä¾‹...`);
                
                setTimeout(() => {
                    const examples = [
                        `ğŸ’¡ **${keywords}è¨­è¨ˆå»ºè­°ï¼š**\n`,
                        'â€¢ ä¿æŒç°¡æ½”æ˜äº†çš„è¦–è¦ºå±¤æ¬¡',
                        'â€¢ ä½¿ç”¨ä¸€è‡´çš„è‰²å½©å’Œå­—é«”',
                        'â€¢ ç¢ºä¿è¶³å¤ çš„å°æ¯”åº¦å’Œå¯è®€æ€§',
                        'â€¢ éµå¾ªä½¿ç”¨è€…çš„æ“ä½œç¿’æ…£',
                        '\nğŸ¨ **æ¨è–¦åƒè€ƒï¼š**',
                        'â€¢ Material Design è¨­è¨ˆè¦ç¯„',
                        'â€¢ Apple Human Interface Guidelines',
                        'â€¢ å„ªç§€çš„è¨­è¨ˆä½œå“é›†ç¶²ç«™å¦‚ Dribbbleã€Behance',
                        '\nâœ¨ è«‹ç¹¼çºŒåœ¨ç•«å¸ƒä¸Šå‰µä½œï¼Œæˆ‘æœƒç‚ºæ‚¨æä¾›æ›´å…·é«”çš„å»ºè­°ï¼'
                    ].join('\n');
                    
                    addChatMessage('AI', examples);
                }, 1000);
            }
            
            // æä¾›ç¹ªåœ–æ•™å­¸å‡½æ•¸
            function provideDrawingTutorial(message) {
                addChatMessage('AI', 'ğŸ“š **ç¹ªåœ–æ•™å­¸æŒ‡å—ï¼š**\n\n' +
                    'ğŸ–±ï¸ **åŸºæœ¬æ“ä½œï¼š**\n' +
                    'â€¢ é»æ“Šä¸¦æ‹–å‹•æ»‘é¼ é€²è¡Œç¹ªåœ–\n' +
                    'â€¢ ä½¿ç”¨å³å´çš„é¡è‰²é¸æ“‡å™¨è®Šæ›´é¡è‰²\n' +
                    'â€¢ èª¿æ•´ç­†åˆ·å¤§å°æ»‘æ¡¿æ§åˆ¶ç·šæ¢ç²—ç´°\n' +
                    'â€¢ é»æ“Šã€Œæ¸…é™¤ã€é‡æ–°é–‹å§‹\n\n' +
                    'ğŸ¨ **è¨­è¨ˆæŠ€å·§ï¼š**\n' +
                    'â€¢ å…ˆç•«å¤§è‡´è¼ªå»“ï¼Œå†æ·»åŠ ç´°ç¯€\n' +
                    'â€¢ ä½¿ç”¨å°æ¯”è‰²çªå‡ºé‡è¦å…ƒç´ \n' +
                    'â€¢ ä¿æŒè¦–è¦ºå¹³è¡¡å’Œå°ç¨±\n' +
                    'â€¢ é©ç•¶ç•™ç™½è®“è¨­è¨ˆæ›´æ¸…æ™°\n\n' +
                    'ğŸ’¡ **UIè¨­è¨ˆå»ºè­°ï¼š**\n' +
                    'â€¢ æŒ‰éˆ•è¦æœ‰æ˜ç¢ºçš„é‚Šç•Œ\n' +
                    'â€¢ æ–‡å­—è¦æœ‰è¶³å¤ çš„å°æ¯”åº¦\n' +
                    'â€¢ éµå¾ªä¸€è‡´çš„è¨­è¨ˆèªè¨€\n\n' +
                    'âœ¨ é–‹å§‹å‰µä½œå§ï¼å®Œæˆå¾Œé»æ“Šã€Œåˆ†æåœ–åƒã€ç²å¾—å°ˆæ¥­å»ºè­°ã€‚');
            }
            
            // è¨­ç½®é¢æ¿èª¿æ•´åŠŸèƒ½
            setupPanelResizer();
            
            // åˆå§‹åŒ–æ¨¡å¼è¨­ç½®
            updateCanvasCursor();
            
            // æ·»åŠ éµç›¤äº‹ä»¶ç›£è½å™¨ï¼ˆEscape éµå–æ¶ˆåœˆé¸æº–å‚™ï¼‰
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' || e.key === 'Esc') {
                    if (isReadyToSelect || isSelecting) {
                        console.log('âš ï¸  æŒ‰ Escape å–æ¶ˆåœˆé¸');
                        isReadyToSelect = false;
                        isSelecting = false;
                        clearSelection();
                        addChatMessage('AI', 'âŒ **å·²å–æ¶ˆåœˆé¸**');
                    }
                }
            });
            
            console.log('âœ… æ‡‰ç”¨åˆå§‹åŒ–å®Œæˆï¼ç•«ç•«å’Œåœˆé¸åŠŸèƒ½å°±ç·’');
            
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }
        
        // ç§»å‹•æŒ‰éˆ• - ç§»å‹•æ¨¡å¼åˆ‡æ›
        moveBtn = document.getElementById('move-btn');
        if (moveBtn) {
            moveBtn.addEventListener('click', function() {
                if (selectionOperation === 'move') {
                    setSelectionOperation(null); // å–æ¶ˆç§»å‹•
                } else {
                    setSelectionOperation('move'); // æ¿€æ´»ç§»å‹•
                }
            });
        }

        // æ¸¬è©¦å…§å®¹æŒ‰éˆ• - æ·»åŠ æ¸¬è©¦åœ–ç‰‡å’Œç­†ç•«
        const testContentBtn = document.getElementById('test-content-btn');
        if (testContentBtn) {
            testContentBtn.addEventListener('click', function() {
                addTestContent();
                addChatMessage('AI', 'âœ… å·²æ·»åŠ æ¸¬è©¦å…§å®¹ï¼\n\nç¾åœ¨ä½ å¯ä»¥æ¸¬è©¦ç§»å‹•åŠŸèƒ½ï¼š\n1. é»æ“Šã€ŒğŸ–ï¸ ç§»å‹•é¸å–ã€æŒ‰éˆ•\n2. åœ¨ç•«å¸ƒä¸Šæ‹–æ‹½åœˆé¸å…§å®¹\n3. æ‹–æ‹½ç§»å‹•é¸ä¸­çš„é …ç›®');
            });
        }

        // é¡¯ç¤ºé¸å–æ¨¡å¼å°è©±æ¡†
        function showSelectionModeDialog(selection) {
            const dialog = document.getElementById('selection-mode-dialog');
            dialog.style.display = 'flex';

            // è¨­ç½®äº‹ä»¶ç›£è½å™¨
            const objectSelectBtn = document.getElementById('object-select-btn');
            const preciseSelectBtn = document.getElementById('precise-select-btn');
            const cancelBtn = document.getElementById('cancel-selection-btn');

            // è‡¨æ™‚è®Šé‡å­˜å„²é¸æ“‡å€åŸŸ
            window.currentSelection = selection;

            // ç‰©ä»¶é¸å–æ¨¡å¼
            objectSelectBtn.onclick = function() {
                console.log('ğŸ“¦ é¸æ“‡ç‰©ä»¶é¸å–æ¨¡å¼');
                addChatMessage('AI', 'ğŸ“¦ **ç‰©ä»¶é¸å–æ¨¡å¼**\n\né¸å–å®Œæ•´çš„ç‰©ä»¶å–®ä½ï¼Œä¿æŒç‰©ä»¶å®Œæ•´æ€§');

                // åŸ·è¡Œç‰©ä»¶é¸å–é‚è¼¯
                selectedItems = getItemsInSelection(selection);
                console.log('ğŸ–ï¸ ç‰©ä»¶é¸å–æ¨¡å¼é¸ä¸­é …ç›®:', selectedItems.length, 'å€‹');

                if (selectedItems.length > 0) {
                    addChatMessage('AI', `âœ… é¸ä¸­äº† ${selectedItems.length} å€‹å®Œæ•´ç‰©ä»¶ï¼Œè«‹æ‹–æ‹½ç§»å‹•`);
                    updateCanvasCursor(); // æ›´æ–°ç‚ºç§»å‹•æ¸¸æ¨™
                } else {
                    addChatMessage('AI', 'âŒ åœˆé¸å€åŸŸå…§æ²’æœ‰æ‰¾åˆ°å®Œæ•´çš„ç‰©ä»¶');
                }

                dialog.style.display = 'none';
            };

            // ç²¾ç¢ºåˆ‡å‰²æ¨¡å¼
            preciseSelectBtn.onclick = function() {
                console.log('âœ‚ï¸ é¸æ“‡ç²¾ç¢ºåˆ‡å‰²æ¨¡å¼');
                addChatMessage('AI', 'âœ‚ï¸ **ç²¾ç¢ºåˆ‡å‰²æ¨¡å¼**\n\næ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œç›®å‰åªèƒ½é€²è¡Œç‰©ä»¶é¸å–');

                // ç›®å‰å…ˆåŸ·è¡Œç‰©ä»¶é¸å–é‚è¼¯
                selectedItems = getItemsInSelection(selection);
                console.log('ğŸ–ï¸ ç²¾ç¢ºåˆ‡å‰²æ¨¡å¼é¸ä¸­é …ç›®:', selectedItems.length, 'å€‹');

                if (selectedItems.length > 0) {
                    addChatMessage('AI', `âœ… è‡¨æ™‚ä½¿ç”¨ç‰©ä»¶é¸å–ï¼šé¸ä¸­äº† ${selectedItems.length} å€‹é …ç›®ï¼Œè«‹æ‹–æ‹½ç§»å‹•`);
                    updateCanvasCursor(); // æ›´æ–°ç‚ºç§»å‹•æ¸¸æ¨™
                } else {
                    addChatMessage('AI', 'âŒ åœˆé¸å€åŸŸå…§æ²’æœ‰æ‰¾åˆ°å…§å®¹');
                }

                dialog.style.display = 'none';
            };

            // å–æ¶ˆæŒ‰éˆ•
            cancelBtn.onclick = function() {
                console.log('âŒ å–æ¶ˆé¸å–æ¨¡å¼é¸æ“‡');
                addChatMessage('AI', 'âŒ å·²å–æ¶ˆé¸å–æ“ä½œ');
                dialog.style.display = 'none';
                updateCanvasCursor(); // é‡ç½®æ¸¸æ¨™
            };

            // é»æ“ŠèƒŒæ™¯é—œé–‰
            dialog.onclick = function(e) {
                if (e.target === dialog) {
                    cancelBtn.click();
                }
            };
        }

        // æ·»åŠ æ¸¬è©¦å…§å®¹çš„å‡½æ•¸
        function addTestContent() {
            // æ·»åŠ ä¸€å€‹æ¸¬è©¦åœ–ç‰‡ï¼ˆç”¨å½©è‰²çŸ©å½¢ä»£æ›¿ï¼‰
            const testImage = {
                x: 100,
                y: 100,
                width: 80,
                height: 60,
                imageData: null, // å¯¦éš›é …ç›®ä¸­é€™æœƒæ˜¯åœ–ç‰‡æ•¸æ“š
                color: '#3498db' // ç”¨æ–¼ç¹ªè£½æ¸¬è©¦çŸ©å½¢
            };
            images.push(testImage);

            // æ·»åŠ ä¸€å€‹æ¸¬è©¦ç­†ç•«ï¼ˆç°¡å–®çš„ç·šæ¢ï¼‰
            const testStroke = {
                points: [
                    {x: 250, y: 150},
                    {x: 300, y: 150},
                    {x: 320, y: 170},
                    {x: 280, y: 190}
                ],
                color: '#e74c3c',
                size: 3
            };
            strokes.push(testStroke);

            // æ·»åŠ ä¸€å€‹æ¸¬è©¦å…¬å¼ï¼ˆç”¨çŸ©å½¢ä»£æ›¿ï¼‰
            const testFormula = {
                x: 400,
                y: 120,
                width: 120,
                height: 40,
                text: 'E=mcÂ²', // æ¸¬è©¦ç”¨çš„å…¬å¼æ–‡æœ¬
                color: '#27ae60'
            };
            images.push(testFormula);

            // é‡ç¹ªç•«å¸ƒä»¥é¡¯ç¤ºæ¸¬è©¦å…§å®¹
            redrawCanvas();

            console.log('ğŸ§ª å·²æ·»åŠ æ¸¬è©¦å…§å®¹:', {images: images.length, strokes: strokes.length});
        }
        
        // ç¸®æ”¾æŒ‰éˆ• - ç¸®æ”¾æ¨¡å¼åˆ‡æ›
        scaleBtn = document.getElementById('scale-btn');
        if (scaleBtn) {
            scaleBtn.addEventListener('click', function() {
                if (selectionOperation === 'scale') {
                    setSelectionOperation(null); // å–æ¶ˆç¸®æ”¾
                } else {
                    setSelectionOperation('scale'); // æ¿€æ´»ç¸®æ”¾
                }
            });
        }
        
        // åˆªé™¤æŒ‰éˆ• - åˆªé™¤æ¨¡å¼åˆ‡æ›
        deleteBtn = document.getElementById('delete-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                if (selectionOperation === 'delete') {
                    setSelectionOperation(null); // å–æ¶ˆåˆªé™¤
                } else {
                    setSelectionOperation('delete'); // æ¿€æ´»åˆªé™¤
                }
            });
        }
    </script>

    <!-- é¸å–æ¨¡å¼å°è©±æ¡† -->
    <div id="selection-mode-dialog" class="dialog-overlay" style="display: none;">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>é¸æ“‡é¸å–æ¨¡å¼</h3>
            </div>
            <div class="dialog-body">
                <p>è«‹é¸æ“‡å¦‚ä½•é¸å–åœˆé¸å€åŸŸå…§çš„å…§å®¹ï¼š</p>
                <div class="mode-options">
                    <button class="mode-btn" id="object-select-btn">
                        <div class="mode-icon">ğŸ“¦</div>
                        <div class="mode-title">ç‰©ä»¶é¸å–</div>
                        <div class="mode-desc">é¸å–å®Œæ•´çš„ç‰©ä»¶å–®ä½ï¼Œä¿æŒç‰©ä»¶å®Œæ•´æ€§</div>
                    </button>
                    <button class="mode-btn" id="precise-select-btn">
                        <div class="mode-icon">âœ‚ï¸</div>
                        <div class="mode-title">ç²¾ç¢ºåˆ‡å‰²</div>
                        <div class="mode-desc">ç²¾ç¢ºé¸å–å€åŸŸå…§çš„éƒ¨åˆ†å…§å®¹ï¼ˆé–‹ç™¼ä¸­ï¼‰</div>
                    </button>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-secondary" id="cancel-selection-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</body>
</html>